<!DOCTYPE html>
<html lang="pl">
<head>
    <title>{{ car.marka }} {{ car.model }} ({{ car.rok }}) - Giełda Radom</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="description" content="Sprawdź ogłoszenie: {{ car.marka }} {{ car.model }} z {{ car.rok }} roku. Lokalna Giełda Samochodowa Radom.">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Anton&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

    <style>
        :root { 
            --radom-red: #ce2b37; 
            --radom-dark: #1a1a1a;
            --mubi-blue: #0056b3;
            --cv-yellow: #ffda00;
            --gemini-blue: #4285f4;
        }
        body { font-family: 'Inter', sans-serif; background-color: #fcefe9; min-height: 100vh; display: flex; flex-direction: column; }

        .navbar { background: rgba(26, 26, 26, 0.95); border-bottom: 3px solid var(--radom-red); backdrop-filter: blur(10px); }

        /* Swiper Gallery */
        .swiper { width: 100%; height: 550px; border-radius: 30px; background: #000; box-shadow: 0 15px 35px rgba(0,0,0,0.2); }
        .swiper-slide { display: flex; justify-content: center; align-items: center; }
        .swiper-slide img { width: 100%; height: 100%; object-fit: cover; cursor: zoom-in; }
        .swiper-button-next, .swiper-button-prev { color: white; background: rgba(0,0,0,0.3); width: 45px; height: 45px; border-radius: 50%; backdrop-filter: blur(5px); }
        .swiper-button-next:after, .swiper-button-prev:after { font-size: 18px; font-weight: bold; }

        /* Ulubione w widoku szczegółów */
        .fav-btn-detail { position: absolute; top: 25px; right: 25px; z-index: 100; background: white; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: none; box-shadow: 0 5px 15px rgba(0,0,0,0.15); transition: 0.3s; }
        .fav-btn-detail:hover { transform: scale(1.1); }
        .fav-btn-detail i { font-size: 1.5rem; }

        /* Miniaturki */
        .gallery-thumbs-wrapper { padding: 15px 0; }
        .thumb-img { width: 110px; height: 75px; object-fit: cover; cursor: pointer; transition: 0.3s; opacity: 0.5; border-radius: 12px; border: 3px solid transparent; flex-shrink: 0; }
        .thumb-img.active-thumb { opacity: 1; border-color: var(--radom-red); transform: translateY(-3px); }

        /* Informacje */
        .info-card { border: none; border-radius: 24px; background: white; box-shadow: 0 8px 30px rgba(0,0,0,0.04); margin-bottom: 25px; }
        .price-tag { color: var(--radom-red); font-size: 3rem; font-weight: 800; letter-spacing: -1.5px; line-height: 1; }
        .param-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .param-item { background: #f8f9fa; border-radius: 18px; padding: 15px; border: 1px solid #eee; }

        /* Stopka */
        .footer-main { background: var(--radom-dark); color: #bbb; padding: 60px 0 30px; margin-top: auto; border-top: 4px solid var(--radom-red); }
        .footer-link { color: #bbb; text-decoration: none; display: block; margin-bottom: 12px; transition: 0.2s; }
        .footer-link:hover { color: var(--radom-red); padding-left: 8px; }

        /* Sekcje Partnerskie */
        .service-box { border-radius: 20px; padding: 22px; margin-bottom: 18px; transition: 0.3s; position: relative; overflow: hidden; }
        .box-cv { background: #fff9db; border: 1px solid #ffe066; }
        .box-mubi { background: #f0f7ff; border: 1px solid #cfe2ff; }

        /* NOWA SEKACJA: GEMINI AI */
        .box-gemini { 
            background: linear-gradient(135deg, #f0f4ff 0%, #ffffff 100%); 
            border: 1px solid #d2e3fc; 
            box-shadow: 0 10px 20px rgba(66, 133, 244, 0.05);
        }
        .gemini-sparkle {
            background: linear-gradient(90deg, #4285f4, #9b72f3, #d96570);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 800;
        }

        .custom-scrollbar::-webkit-scrollbar { height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: var(--radom-red); border-radius: 10px; }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
        <div class="container">
            <a class="navbar-brand fw-bold fs-3" href="/"><i class="bi bi-speedometer2 text-danger"></i> Giełda Radom</a>
            <div class="ms-auto">
                <a href="/" class="btn btn-danger rounded-pill px-4 btn-sm" style="background-color: var(--radom-red);">Wszystkie ogłoszenia</a>
            </div>
        </div>
    </nav>

    <div class="container my-5">
        <div class="row g-4">
            <div class="col-lg-8">
                <div class="position-relative">
                    {% set pozostalo = 30 - (now - car.data_dodania).days %}
                    <div class="time-badge-detail badge rounded-pill bg-white text-dark shadow p-2 px-3" style="position: absolute; top: 20px; left: 20px; z-index: 10;">
                        <i class="bi bi-clock-fill text-danger me-1"></i> Jeszcze {{ pozostalo }} dni
                    </div>

                    {% if current_user.is_authenticated %}
                    <a href="{{ url_for('toggle_favorite', car_id=car.id) }}" class="fav-btn-detail">
                        <i class="bi {{ 'bi-heart-fill text-danger' if car in current_user.favorite_cars else 'bi-heart' }}"></i>
                    </a>
                    {% endif %}

                    <div class="swiper mySwiper">
                        <div class="swiper-wrapper">
                            <div class="swiper-slide"><img src="{{ car.img }}" onclick="openLightbox('{{ car.img }}')"></div>
                            {% for extra_img in car.images %}
                                {% if extra_img.image_path != car.img %}
                                <div class="swiper-slide"><img src="{{ extra_img.image_path }}" onclick="openLightbox('{{ extra_img.image_path }}')"></div>
                                {% endif %}
                            {% endfor %}
                        </div>
                        <div class="swiper-button-next"></div>
                        <div class="swiper-button-prev"></div>
                        <div class="swiper-pagination"></div>
                    </div>
                </div>

                <div class="gallery-thumbs-wrapper">
                    <div class="d-flex gap-2 overflow-x-auto pb-2 custom-scrollbar">
                        <img src="{{ car.img }}" class="thumb-img active-thumb" data-index="0">
                        {% for extra_img in car.images %}
                            {% if extra_img.image_path != car.img %}
                            <img src="{{ extra_img.image_path }}" class="thumb-img" data-index="{{ loop.index }}">
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>

                <div class="info-card p-4 p-md-5">
                    <h3 class="fw-bold mb-4 border-bottom pb-3"><i class="bi bi-list-stars text-danger me-2"></i>Dane techniczne</h3>
                    <div class="row g-3 mb-4">
                        <div class="col-6 col-md-3">
                            <div class="small text-muted">Paliwo</div>
                            <div class="fw-bold">{{ car.paliwo or 'Nie podano' }}</div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="small text-muted">Skrzynia</div>
                            <div class="fw-bold">{{ car.skrzynia or 'Nie podano' }}</div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="small text-muted">Nadwozie</div>
                            <div class="fw-bold">{{ car.nadwozie or 'Nie podano' }}</div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="small text-muted">Silnik</div>
                            <div class="fw-bold">{{ car.pojemnosc or 'Nie podano' }}</div>
                        </div>
                    </div>
                    
                    <h3 class="fw-bold mb-4 border-bottom pb-3 mt-4"><i class="bi bi-info-circle text-danger me-2"></i>Opis pojazdu</h3>
                    <div class="fs-5 text-dark" style="white-space: pre-line; line-height: 1.8;">
                        {{ car.opis }}
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="info-card p-4 sticky-top" style="top: 100px;">
                    <div class="mb-2"><span class="badge bg-danger">{{ car.zrodlo }}</span> <span class="text-muted small">ID: #{{ car.id }}</span></div>
                    <h1 class="h2 fw-bold mb-1">{{ car.marka }} {{ car.model }}</h1>
                    <p class="text-muted fw-bold mb-4">Używane • {{ car.rok }} r.</p>

                    <div class="price-tag mb-4">{{ car.cena|int }} <span class="fs-4">PLN</span></div>

                    {% set analysis = get_market_valuation(car) %}
                    <div class="service-box box-gemini">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span class="small fw-800 text-uppercase gemini-sparkle">Gemini AI Market Insight</span>
                            <div class="spinner-grow spinner-grow-sm text-primary" role="status"></div>
                        </div>
                        
                        <div class="position-relative mb-2" style="height: 6px; background: #e0e8f5; border-radius: 10px;">
                            <div class="position-absolute shadow-sm" style="left: {{ analysis.pos }}%; top: -5px; width: 16px; height: 16px; background: {{ analysis.color }}; border: 3px solid white; border-radius: 50%; z-index: 5; transition: 1s ease-in-out;"></div>
                        </div>
                        <div class="d-flex justify-content-between mb-3" style="font-size: 0.6rem; font-weight: 700; color: #7a869a;">
                            <span>OKAZJA</span>
                            <span>ŚREDNIA PL</span>
                            <span>DROGO</span>
                        </div>
                        
                        <div class="bg-white p-2 rounded-3 border-0 shadow-sm text-center">
                            <span class="small fw-bold" style="color: {{ analysis.color }};">
                                <i class="bi bi-stars me-1"></i> {{ analysis.status }}
                            </span>
                            <div class="text-muted" style="font-size: 0.65rem;">Cena w Polsce odbiega o {{ analysis.diff }}% od średniej</div>
                        </div>
                        <p class="text-center mt-2 mb-0" style="font-size: 0.55rem; opacity: 0.6;">Powered by Google Gemini Pro Engine 2026</p>
                    </div>

                    <div class="param-grid mb-4">
                        <div class="param-item">
                            <div class="small text-muted text-uppercase fw-bold" style="font-size: 0.65rem;">Rok Produkcji</div>
                            <div class="fw-bold fs-5">{{ car.rok }}</div>
                        </div>
                        <div class="param-item">
                            <div class="small text-muted text-uppercase fw-bold" style="font-size: 0.65rem;">Lokalizacja</div>
                            <div class="fw-bold fs-5">{{ car.zrodlo }}</div>
                        </div>
                    </div>

                    <div class="d-grid mb-4">
                        <a href="tel:{{ car.telefon }}" class="btn btn-danger btn-lg rounded-pill py-3 fw-bold shadow-lg" style="background-color: var(--radom-red);">
                            <i class="bi bi-telephone-outbound-fill me-2"></i> Zadzwoń: {{ car.telefon }}
                        </a>
                    </div>

                    <div class="service-box box-cv">
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-search text-warning fs-3 me-2"></i>
                            <span class="fw-bold">Historia carVertical</span>
                        </div>
                        <p class="small text-muted">Sprawdź przebieg i czy auto nie jest po wypadku.</p>
                        <a href="https://www.carvertical.com/pl" target="_blank" class="btn btn-outline-dark btn-sm w-100 rounded-pill fw-bold">Pobierz raport PDF</a>
                    </div>

                    <div class="service-box box-mubi">
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-shield-check text-primary fs-3 me-2"></i>
                            <span class="fw-bold">Ubezpieczenie OC</span>
                        </div>
                        <p class="small text-muted">Oblicz składkę i odbierz 150 zł zwrotu na konto.</p>
                        <a href="https://mubi.pl" target="_blank" class="btn btn-primary btn-sm w-100 rounded-pill fw-bold border-0" style="background-color: var(--mubi-blue);">Oblicz OC z bonusem</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer-main">
        <div class="container">
            <div class="row gy-4">
                <div class="col-lg-4">
                    <a href="/" class="text-white text-decoration-none fw-bold fs-3"><i class="bi bi-speedometer2 text-danger"></i> Giełda Radom</a>
                    <p class="small mt-3">Największy portal motoryzacyjny w regionie radomskim. Kupuj i sprzedawaj lokalnie. Pamiętamy o historii Czerwca '76.</p>
                </div>
                <div class="col-lg-2">
                    <h6 class="text-white fw-bold mb-3">Portal</h6>
                    <a href="/" class="footer-link small">Strona główna</a>
                    <a href="/register" class="footer-link small">Dodaj ogłoszenie</a>
                </div>
                <div class="col-lg-3">
                    <h6 class="text-white fw-bold mb-3">Pomoc</h6>
                    <a href="/regulamin" class="footer-link small">Regulamin</a>
                    <a href="/polityka-prywatnosci" class="footer-link small">Polityka prywatności</a>
                    <a href="/kontakt" class="footer-link small">Kontakt</a>
                </div>
                <div class="col-lg-3 text-md-end">
                    <h6 class="text-white fw-bold mb-3">Śledź nas</h6>
                    <div class="d-flex justify-content-md-end gap-3 fs-4 mb-3">
                        <i class="bi bi-facebook opacity-50"></i>
                        <i class="bi bi-instagram opacity-50"></i>
                    </div>
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e9/Flag_of_Radom.svg/800px-Flag_of_Radom.svg.png" style="height: 20px; opacity: 0.3;">
                </div>
            </div>
            <hr class="my-4 border-secondary opacity-25">
            <div class="text-center small opacity-50">© 2026 Giełda Radom. Wszystkie prawa zastrzeżone.</div>
        </div>
    </footer>

    <div class="modal fade" id="lightboxModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content bg-transparent border-0">
                <div class="modal-body p-0 text-center">
                    <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3" data-bs-dismiss="modal"></button>
                    <img src="" id="lightboxImg" class="img-fluid rounded shadow-lg">
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        var swiper = new Swiper(".mySwiper", {
            loop: false,
            navigation: { nextEl: ".swiper-button-next", prevEl: ".swiper-button-prev" },
            pagination: { el: ".swiper-pagination", clickable: true },
            on: { slideChange: function () { updateThumbs(this.activeIndex); } }
        });

        const thumbs = document.querySelectorAll('.thumb-img');
        thumbs.forEach(t => {
            t.addEventListener('click', function() { swiper.slideTo(parseInt(this.getAttribute('data-index'))); });
        });

        function updateThumbs(index) {
            thumbs.forEach(t => t.classList.remove('active-thumb'));
            const active = document.querySelector(`.thumb-img[data-index="${index}"]`);
            if (active) {
                active.classList.add('active-thumb');
                active.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }
        }

        function openLightbox(src) {
            document.getElementById('lightboxImg').src = src;
            new bootstrap.Modal(document.getElementById('lightboxModal')).show();
        }
    </script>
</body>
</html>
