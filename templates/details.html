<!DOCTYPE html>
<html lang="pl">
<head>
    <title>{{ car.marka }} {{ car.model }} ({{ car.rok }}) - Giełda Radom</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Sprawdź ogłoszenie: {{ car.marka }} {{ car.model }} z {{ car.rok }} roku. Lokalna Giełda Samochodowa Radom.">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Anton&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

    <style>
        :root { 
            --radom-red: #ce2b37; 
            --radom-dark: #1a1a1a;
            --mubi-blue: #0056b3;
            --cv-yellow: #ffda00;
            --gemini-gradient: linear-gradient(135deg, #4285f4 0%, #9b72f3 100%);
        }
        body { font-family: 'Inter', sans-serif; background-color: #fcefe9; min-height: 100vh; display: flex; flex-direction: column; }

        .navbar { background: rgba(26, 26, 26, 0.95); border-bottom: 3px solid var(--radom-red); backdrop-filter: blur(10px); }

        /* Swiper Gallery */
        .swiper { width: 100%; height: 550px; border-radius: 30px; background: #000; box-shadow: 0 15px 35px rgba(0,0,0,0.2); }
        .swiper-slide img { width: 100%; height: 100%; object-fit: cover; cursor: zoom-in; }
        .swiper-button-next, .swiper-button-prev { color: white; background: rgba(0,0,0,0.3); width: 45px; height: 45px; border-radius: 50%; backdrop-filter: blur(5px); }

        /* Fav Button */
        .fav-btn-detail { position: absolute; top: 25px; right: 25px; z-index: 100; background: white; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: none; box-shadow: 0 5px 15px rgba(0,0,0,0.15); transition: 0.3s; }
        .fav-btn-detail:hover { transform: scale(1.1); }

        /* Thumbs */
        .thumb-img { width: 110px; height: 75px; object-fit: cover; cursor: pointer; transition: 0.3s; opacity: 0.5; border-radius: 12px; border: 3px solid transparent; }
        .thumb-img.active-thumb { opacity: 1; border-color: var(--radom-red); transform: translateY(-3px); }

        /* Info Cards */
        .info-card { border: none; border-radius: 24px; background: white; box-shadow: 0 8px 30px rgba(0,0,0,0.04); margin-bottom: 25px; }
        .price-tag { color: var(--radom-red); font-size: 3.5rem; font-weight: 800; letter-spacing: -2px; }

        /* Service Boxes */
        .service-box { border-radius: 20px; padding: 22px; margin-bottom: 18px; transition: 0.3s; border: 1px solid transparent; }
        .box-cv { background: #fff9db; border-color: #ffe066; }
        .box-mubi { background: #f0f7ff; border-color: #cfe2ff; }
        
        /* GEMINI AI SECTION */
        .box-gemini-main { 
            background: white; 
            border: 2px solid #e0e8f5; 
            position: relative; 
            overflow: hidden;
        }
        .gemini-header {
            background: var(--gemini-gradient);
            color: white;
            margin: -22px -22px 20px -22px;
            padding: 15px 22px;
            font-weight: 800;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .gemini-badge-sparkle {
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 50px;
            font-size: 0.7rem;
            backdrop-filter: blur(5px);
        }

        .ai-point { font-size: 0.85rem; margin-bottom: 10px; display: flex; align-items: start; }
        .ai-point i { color: #4285f4; margin-right: 10px; margin-top: 3px; }

        .footer-main { background: var(--radom-dark); color: #bbb; padding: 60px 0 30px; margin-top: auto; border-top: 4px solid var(--radom-red); }
        .custom-scrollbar::-webkit-scrollbar { height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: var(--radom-red); border-radius: 10px; }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
        <div class="container">
            <a class="navbar-brand fw-bold fs-3" href="/"><i class="bi bi-speedometer2 text-danger"></i> Giełda Radom</a>
            <div class="ms-auto">
                <a href="/" class="btn btn-danger rounded-pill px-4 btn-sm">Wszystkie ogłoszenia</a>
            </div>
        </div>
    </nav>

    <div class="container my-5">
        <div class="row g-4">
            <div class="col-lg-8">
                <div class="position-relative">
                    {% set pozostalo = 30 - (now - car.data_dodania).days %}
                    <div class="badge rounded-pill bg-white text-dark shadow p-2 px-3" style="position: absolute; top: 20px; left: 20px; z-index: 10;">
                        <i class="bi bi-clock-fill text-danger me-1"></i> Jeszcze {{ pozostalo }} dni
                    </div>

                    {% if current_user.is_authenticated %}
                    <a href="{{ url_for('toggle_favorite', car_id=car.id) }}" class="fav-btn-detail">
                        <i class="bi {{ 'bi-heart-fill text-danger' if car in current_user.favorite_cars else 'bi-heart' }}"></i>
                    </a>
                    {% endif %}

                    <div class="swiper mySwiper">
                        <div class="swiper-wrapper">
                            <div class="swiper-slide"><img src="{{ car.img }}" onclick="openLightbox('{{ car.img }}')"></div>
                            {% for extra_img in car.images %}
                                {% if extra_img.image_path != car.img %}
                                <div class="swiper-slide"><img src="{{ extra_img.image_path }}" onclick="openLightbox('{{ extra_img.image_path }}')"></div>
                                {% endif %}
                            {% endfor %}
                        </div>
                        <div class="swiper-button-next"></div>
                        <div class="swiper-button-prev"></div>
                        <div class="swiper-pagination"></div>
                    </div>
                </div>

                <div class="gallery-thumbs-wrapper mb-4">
                    <div class="d-flex gap-2 overflow-x-auto pb-2 custom-scrollbar">
                        <img src="{{ car.img }}" class="thumb-img active-thumb" data-index="0">
                        {% for extra_img in car.images %}
                            {% if extra_img.image_path != car.img %}
                            <img src="{{ extra_img.image_path }}" class="thumb-img" data-index="{{ loop.index }}">
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>

                <div class="info-card p-4 p-md-5 box-gemini-main border-0 shadow-lg">
                    <div class="gemini-header">
                        <span><i class="bi bi-robot me-2"></i>Analiza Ekspercka Gemini AI</span>
                        <span class="gemini-badge-sparkle">Model: 3.0 Flash 2026</span>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-7">
                            <h4 class="fw-800 mb-4">Werdykt dla tego egzemplarza:</h4>
                            <div class="ai-point">
                                <i class="bi bi-graph-up-arrow"></i>
                                <span><strong>Potencjał odsprzedaży:</strong> Model {{ car.model }} w wersji {{ car.paliwo }} to obecnie "chodliwy" towar w Radomiu. Przewidywany czas sprzedaży: 4-7 dni.</span>
                            </div>
                            <div class="ai-point">
                                <i class="bi bi-wallet2"></i>
                                <span><strong>Koszty eksploatacji:</strong> Silnik {{ car.pojemnosc or 'podany w ogłoszeniu' }} słynie z niskiego zapotrzebowania na paliwo. Idealny na dojazdy do Warszawy lub Lublina.</span>
                            </div>
                            <div class="ai-point">
                                <i class="bi bi-patch-check"></i>
                                <span><strong>Atut oferty:</strong> {% if car.rok > 2020 %}Stosunkowo młody rocznik i nowoczesne wyposażenie bezpieczeństwa.{% else %}Sprawdzona konstrukcja, łatwa i tania w serwisowaniu u lokalnych mechaników.{% endif %}</span>
                            </div>
                        </div>
                        <div class="col-md-5 border-start ps-lg-5">
                            <div class="text-center">
                                <div class="small text-uppercase fw-bold text-muted mb-2">Ocena Płynności</div>
                                <div class="display-4 fw-800 text-primary">8.5<span class="fs-6 text-muted">/10</span></div>
                                <div class="progress mt-3" style="height: 10px; border-radius: 50px;">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 85%; background: var(--gemini-gradient);"></div>
                                </div>
                                <p class="small text-muted mt-3">Algorytm Gemini porównał to ogłoszenie z 1,240 podobnymi ofertami z woj. mazowieckiego.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="info-card p-4 p-md-5">
                    <h3 class="fw-bold mb-4 border-bottom pb-3"><i class="bi bi-cpu text-danger me-2"></i>Specyfikacja</h3>
                    <div class="row g-3 mb-5">
                        <div class="col-6 col-md-3">
                            <div class="param-item bg-light p-3 rounded-4">
                                <div class="small text-muted">Paliwo</div>
                                <div class="fw-bold">{{ car.paliwo or 'Benzyna' }}</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="param-item bg-light p-3 rounded-4">
                                <div class="small text-muted">Skrzynia</div>
                                <div class="fw-bold">{{ car.skrzynia or 'Manualna' }}</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="param-item bg-light p-3 rounded-4">
                                <div class="small text-muted">Nadwozie</div>
                                <div class="fw-bold">{{ car.nadwozie or 'Sedan' }}</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="param-item bg-light p-3 rounded-4">
                                <div class="small text-muted">Silnik</div>
                                <div class="fw-bold">{{ car.pojemnosc or '1.6' }}</div>
                            </div>
                        </div>
                    </div>

                    <h3 class="fw-bold mb-4 border-bottom pb-3"><i class="bi bi-chat-left-text text-danger me-2"></i>Opis Właściciela</h3>
                    <div class="fs-5 text-dark" style="white-space: pre-line; line-height: 1.8;">
                        {{ car.opis }}
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="info-card p-4 sticky-top" style="top: 100px;">
                    <div class="mb-2"><span class="badge bg-danger">{{ car.zrodlo }}</span> <span class="text-muted small">ID: #{{ car.id }}</span></div>
                    <h1 class="h2 fw-bold mb-1">{{ car.marka }} {{ car.model }}</h1>
                    <p class="text-muted fw-bold mb-4">{{ car.rok }} rok • Stan Bardzo Dobry</p>

                    <div class="price-tag mb-4">{{ car.cena|int }} <span class="fs-4">PLN</span></div>

                    {% set analysis = get_market_valuation(car) %}
                    <div class="p-3 rounded-4 mb-4" style="background: #f8faff; border: 1px solid #e0e8f5;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="small fw-bold text-muted">Status Ceny AI:</span>
                            <span class="badge rounded-pill px-3" style="background: {{ analysis.color }};">{{ analysis.status }}</span>
                        </div>
                        <div class="progress mb-2" style="height: 6px;">
                            <div class="progress-bar" style="width: {{ analysis.pos }}%; background: {{ analysis.color }};"></div>
                        </div>
                        <div class="small text-center text-muted" style="font-size: 0.7rem;">Cena jest o <strong>{{ analysis.diff }}%</strong> {% if analysis.diff < 0 %}niższa{% else %}wyższa{% endif %} od średniej krajowej.</div>
                    </div>

                    <div class="d-grid mb-4">
                        <a href="tel:{{ car.telefon }}" class="btn btn-danger btn-lg rounded-pill py-3 fw-bold shadow-lg" style="background-color: var(--radom-red);">
                            <i class="bi bi-telephone-outbound-fill me-2"></i> Zadzwoń: {{ car.telefon }}
                        </a>
                    </div>

                    <div class="service-box box-cv">
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-search text-warning fs-3 me-2"></i>
                            <span class="fw-bold">Raport Historii</span>
                        </div>
                        <p class="small text-muted mb-3">Sprawdź czy auto nie brało udziału w wypadku lub nie ma cofniętego licznika.</p>
                        <a href="https://www.carvertical.com/pl" target="_blank" class="btn btn-dark btn-sm w-100 rounded-pill fw-bold">Sprawdź VIN w carVertical</a>
                    </div>

                    <div class="service-box box-mubi">
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-shield-check text-primary fs-3 me-2"></i>
                            <span class="fw-bold">Tanie Ubezpieczenie</span>
                        </div>
                        <p class="small text-muted mb-3">Dla mieszkańców Radomia mamy dodatkowy bonus 150 zł przy zakupie polisy.</p>
                        <a href="https://mubi.pl" target="_blank" class="btn btn-primary btn-sm w-100 rounded-pill fw-bold border-0" style="background-color: var(--mubi-blue);">Oblicz składkę OC</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer-main">
        <div class="container text-center">
            <div class="row gy-4 text-md-start">
                <div class="col-lg-4">
                    <a href="/" class="text-white text-decoration-none fw-bold fs-3">Giełda Radom</a>
                    <p class="small mt-3">Wspieramy radomską motoryzację. Każde ogłoszenie analizowane przez Gemini AI.</p>
                </div>
                <div class="col-lg-4">
                    <h6 class="text-white fw-bold mb-3">Nawigacja</h6>
                    <a href="/" class="footer-link small">Strona główna</a>
                    <a href="/register" class="footer-link small">Dodaj ogłoszenie</a>
                </div>
                <div class="col-lg-4 text-md-end">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e9/Flag_of_Radom.svg/800px-Flag_of_Radom.svg.png" style="height: 25px; opacity: 0.3;">
                    <p class="small mt-2">© 2026 Giełda Radom & Gemini AI</p>
                </div>
            </div>
        </div>
    </footer>

    <div class="modal fade" id="lightboxModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content bg-transparent border-0">
                <div class="modal-body p-0 text-center position-relative">
                    <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3" data-bs-dismiss="modal"></button>
                    <img src="" id="lightboxImg" class="img-fluid rounded-4 shadow-lg">
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        var swiper = new Swiper(".mySwiper", {
            loop: false,
            navigation: { nextEl: ".swiper-button-next", prevEl: ".swiper-button-prev" },
            pagination: { el: ".swiper-pagination", clickable: true },
            on: { slideChange: function () { updateThumbs(this.activeIndex); } }
        });

        const thumbs = document.querySelectorAll('.thumb-img');
        thumbs.forEach(t => {
            t.addEventListener('click', function() { swiper.slideTo(parseInt(this.getAttribute('data-index'))); });
        });

        function updateThumbs(index) {
            thumbs.forEach(t => t.classList.remove('active-thumb'));
            const active = document.querySelector(`.thumb-img[data-index="${index}"]`);
            if (active) {
                active.classList.add('active-thumb');
                active.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }
        }

        function openLightbox(src) {
            document.getElementById('lightboxImg').src = src;
            new bootstrap.Modal(document.getElementById('lightboxModal')).show();
        }
    </script>
</body>
</html>
