{% extends "base.html" %}
{% block content %}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@5.4.3/dist/photoswipe.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<style>
    :root { --primary-blue: #007bff; --dark-bg: #1a1a1a; }
    
    /* Galeria i Miniatury */
    .main-img-container {
        border-radius: 15px;
        overflow: hidden;
        background: #000;
        position: relative;
        aspect-ratio: 16/9;
    }
    .main-img-container img {
        width: 100%; height: 100%; object-fit: contain; cursor: zoom-in;
    }
    .thumb-scroll {
        display: flex; gap: 10px; overflow-x: auto; padding: 10px 0;
        scrollbar-width: none;
    }
    .thumb-item {
        width: 80px; height: 60px; border-radius: 8px; 
        object-fit: cover; cursor: pointer; border: 2px solid transparent;
        transition: 0.3s;
    }
    .thumb-item.active { border-color: var(--primary-blue); }

    /* Ramka Analizy Gemini z Suwakiem */
    .gemini-card {
        background: linear-gradient(145deg, #ffffff, #f0f7ff);
        border: 1px solid rgba(0,123,255,0.2);
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    }
    .gemini-scroll-box {
        max-height: 250px;
        overflow-y: auto;
        padding: 15px;
        font-size: 1.05rem;
        line-height: 1.6;
        color: #2c3e50;
    }
    .gemini-scroll-box::-webkit-scrollbar { width: 6px; }
    .gemini-scroll-box::-webkit-scrollbar-thumb { background: var(--primary-blue); border-radius: 10px; }

    /* Dane Techniczne (Badge) */
    .spec-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
    .spec-item {
        background: #f8f9fa; padding: 12px; border-radius: 10px;
        display: flex; align-items: center; gap: 10px;
    }
    .spec-icon { color: var(--primary-blue); font-size: 1.2rem; }

    /* Stopka Partnerów */
    .partner-footer {
        background: #f1f1f1; border-radius: 12px; padding: 20px;
        margin-top: 30px; display: flex; justify-content: space-around;
        align-items: center; flex-wrap: wrap; gap: 20px;
    }
    .partner-logo { filter: grayscale(1); opacity: 0.7; transition: 0.3s; height: 30px; }
    .partner-logo:hover { filter: grayscale(0); opacity: 1; }
</style>

<div class="container mt-4">
    <div class="row">
        <div class="col-lg-8">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/">Giełda Radom</a></li>
                    <li class="breadcrumb-item active">{{ car.marka }} {{ car.model }}</li>
                </ol>
            </nav>

            <div class="pswp-gallery" id="car-gallery">
                <div class="main-img-container shadow">
                    <a href="{{ car.img }}" data-pswp-width="1200" data-pswp-height="800" target="_blank">
                        <img src="{{ car.img }}" id="mainDisplayImg" alt="Główny widok">
                    </a>
                </div>
                <div class="thumb-scroll">
                    <img src="{{ car.img }}" class="thumb-item active" onclick="updateGallery('{{ car.img }}', this)">
                    {% for image in car.images %}
                    <a href="{{ image.image_path }}" data-pswp-width="1200" data-pswp-height="800" target="_blank" style="display:none"></a>
                    <img src="{{ image.image_path }}" class="thumb-item" onclick="updateGallery('{{ image.image_path }}', this)">
                    {% endfor %}
                </div>
            </div>

            <div class="gemini-card mt-4 p-3">
                <h5 class="fw-bold text-primary mb-3">
                    <i class="bi bi-stars"></i> Inteligentna Analiza Gemini 3
                </h5>
                <div class="gemini-scroll-box">
                    {% if "[Analiza" in car.opis %}
                        <div class="user-text mb-3"><strong>Opis właściciela:</strong><br>
                            {{ car.opis.split('[Analiza')[0] }}
                        </div>
                        <hr>
                        <div class="ai-text"><strong>Wnioski AI:</strong><br>
                            {{ car.opis.split('[Analiza')[1].replace('AI]:', '').strip() | safe }}
                        </div>
                    {% else %}
                        {{ car.opis }}
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card border-0 shadow-sm p-3 mb-4">
                <h2 class="fw-bold mb-1">{{ car.marka }} {{ car.model }}</h2>
                <p class="text-muted"><i class="bi bi-geo-alt-fill text-danger"></i> <strong>{{ car.zrodlo }}</strong></p>
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span class="h3 fw-bold text-primary">{{ "{:,.0f}".format(car.cena).replace(',', ' ') }} PLN</span>
                    <button class="btn btn-outline-danger btn-sm"><i class="bi bi-heart"></i> {{ car.favorites_count or 0 }}</button>
                </div>
                
                <div class="spec-grid">
                    <div class="spec-item">
                        <i class="bi bi-speedometer2 spec-icon"></i>
                        <div><small class="text-muted d-block">Przebieg</small><strong>{{ car.przebieg or car.rok }} km</strong></div>
                    </div>
                    <div class="spec-item">
                        <i class="bi bi-gear-wide-connected spec-icon"></i>
                        <div><small class="text-muted d-block">Skrzynia</small><strong>{{ car.skrzynia or 'Manualna' }}</strong></div>
                    </div>
                    <div class="spec-item">
                        <i class="bi bi-droplet-fill spec-icon"></i>
                        <div><small class="text-muted d-block">Paliwo</small><strong>{{ car.paliwo or 'Diesel' }}</strong></div>
                    </div>
                    <div class="spec-item">
                        <i class="bi bi-lightning-fill spec-icon"></i>
                        <div><small class="text-muted d-block">Pojemność</small><strong>{{ car.pojemnosc or '2.0' }} cm³</strong></div>
                    </div>
                </div>

                <hr>
                <div class="d-grid gap-2">
                    <a href="tel:{{ car.telefon }}" class="btn btn-dark btn-lg py-3 fw-bold">
                        <i class="bi bi-telephone-fill me-2"></i> {{ car.telefon }}
                    </a>
                    <div class="text-center mt-2">
                        <small class="text-muted"><i class="bi bi-eye"></i> Wyświetleń: {{ car.views or 124 }}</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="partner-footer shadow-sm">
        <div class="text-center">
            <small class="d-block text-muted mb-2">Sprawdź historię pojazdu:</small>
            <img src="https://www.carvertical.com/static/img/logo/logo-blue.svg" class="partner-logo" alt="carVertical">
        </div>
        <div class="text-center">
            <small class="d-block text-muted mb-2">Znajdź najtańsze OC:</small>
            <img src="https://mubi.pl/static/img/logo-mubi.svg" class="partner-logo" alt="Mubi">
        </div>
        <div class="text-center">
            <p class="mb-0 fw-bold text-muted">Giełda Radom &copy; 2026</p>
        </div>
    </div>
</div>

<script type="module">
    import PhotoSwipeLightbox from 'https://cdn.jsdelivr.net/npm/photoswipe@5.4.3/dist/photoswipe-lightbox.esm.js';
    const lightbox = new PhotoSwipeLightbox({
        gallery: '#car-gallery',
        children: 'a',
        pswpModule: () => import('https://cdn.jsdelivr.net/npm/photoswipe@5.4.3/dist/photoswipe.esm.js')
    });
    lightbox.init();

    window.updateGallery = function(src, thumb) {
        document.getElementById('mainDisplayImg').src = src;
        document.getElementById('mainDisplayImg').parentElement.href = src;
        document.querySelectorAll('.thumb-item').forEach(t => t.classList.remove('active'));
        thumb.classList.add('active');
    };
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const aiTextElement = document.getElementById('mainAiText');
    
    // Jeśli w ramce jest komunikat o generowaniu, wywołaj API
    if (aiTextElement && aiTextElement.innerText.includes("Gemini generuje")) {
        fetch('/analyze_car/{{ car.id }}') // Upewnij się, że masz taki routing w app.py
            .then(response => response.json())
            .then(data => {
                aiTextElement.innerHTML = data.analysis;
            })
            .catch(err => {
                aiTextElement.innerHTML = "Analiza chwilowo niedostępna. Odśwież za chwilę.";
                console.error(err);
            });
    }
});
</script>


{% endblock %}
