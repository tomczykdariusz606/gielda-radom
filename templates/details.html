{% extends "base.html" %}
{% block content %}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@5.4.3/dist/photoswipe.css">

<style>
    body {
        background: url('/static/czerwiec_tlo.jpg') no-repeat center center fixed;
        background-size: cover;
    }
    .main-wrapper {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(8px);
        border-radius: 25px;
        padding: 25px;
        margin-top: 20px;
        box-shadow: 0 15px 35px rgba(0,0,0,0.2);
    }
    .main-img-container { border-radius: 20px; overflow: hidden; background: #000; aspect-ratio: 16/9; }
    .main-img-container img { width: 100%; height: 100%; object-fit: contain; cursor: zoom-in; }
    
    .thumb-item { width: 100px; height: 70px; border-radius: 10px; object-fit: cover; cursor: pointer; border: 3px solid transparent; flex-shrink: 0; }
    .thumb-item.active { border-color: #007bff; }

    .gemini-card { background: white; border-radius: 20px; border: 1px solid #6e45e2; overflow: hidden; margin-top: 20px; }
    .gemini-header { background: linear-gradient(90deg, #6e45e2, #88d3ce); color: white; padding: 12px 20px; }
    .gemini-scroll-box { max-height: 250px; overflow-y: auto; padding: 20px; }

    .partner-btn { display: flex; align-items: center; gap: 10px; padding: 12px; border-radius: 12px; text-decoration: none; font-weight: bold; margin-bottom: 10px; color: white !important; }
    .cv-btn { background: #1b2e4b; border-left: 5px solid #00ff00; }
    .mubi-btn { background: #e30613; border-left: 5px solid #ffffff; }
</style>

<div class="container main-wrapper mb-5">
    <div class="row">
        <div class="col-lg-8">
            <div class="pswp-gallery" id="car-gallery">
                <div class="main-img-container shadow">
                    <a href="{{ car.img }}" data-pswp-width="1200" data-pswp-height="800" target="_blank">
                        <img src="{{ car.img }}" id="mainDisplayImg">
                    </a>
                </div>
                <div class="thumb-scroll d-flex gap-2 mt-3 overflow-auto pb-2">
                    <img src="{{ car.img }}" class="thumb-item active" onclick="updateGallery('{{ car.img }}', this)">
                    {% for image in car.images %}
                        <a href="{{ image.image_path }}" data-pswp-width="1200" data-pswp-height="800" target="_blank" style="display:none"></a>
                        <img src="{{ image.image_path }}" class="thumb-item" onclick="updateGallery('{{ image.image_path }}', this)">
                    {% endfor %}
                </div>
            </div>

            <div class="gemini-card shadow-sm">
                <div class="gemini-header fw-bold"><i class="bi bi-robot"></i> Analiza Ekspercka Gemini 3</div>
                <div class="gemini-scroll-box">
                    {% if "[Analiza" in car.opis %}
                        <p>{{ car.opis.split('[Analiza')[0] }}</p>
                        <hr>
                        <div class="text-primary fw-bold small mb-2">WNIOSKI WIZUALNE AI:</div>
                        {{ car.opis.split('[Analiza')[1].replace('AI]:', '').strip() | safe }}
                    {% else %}
                        {{ car.opis }}
                    {% endif %}
                </div>
            </div>

            <div class="card mt-3 border-primary bg-light p-3 rounded-4">
                <h6 class="fw-bold"><i class="bi bi-chat-dots"></i> Masz pytanie o to auto?</h6>
                <div class="input-group">
                    <input type="text" id="userAiQuery" class="form-control" placeholder="np. Czy ten silnik jest awaryjny?">
                    <button class="btn btn-primary px-4" onclick="askGemini()">Zapytaj AI</button>
                </div>
                <div id="aiResponse" class="mt-3 p-3 bg-white rounded shadow-sm border-start border-4 border-primary" style="display:none;">
                    <div class="spinner-border spinner-border-sm text-primary" id="aiSpinner"></div>
                    <span id="aiResponseText"></span>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
<div class="market-valuation mt-3 mb-4 p-3 border rounded-4 bg-white shadow-sm">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <span class="small fw-bold text-muted">Ocena ceny Gemini AI:</span>
        <span id="priceLabel" class="badge rounded-pill bg-secondary px-3">Sprawdzanie...</span>
    </div>
    
    <div class="progress" style="height: 12px; background-color: #e9ecef; border-radius: 10px;">
        <div id="priceBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%; border-radius: 10px;"></div>
    </div>
    
    <div class="d-flex justify-content-between mt-2">
        <span class="small text-muted" style="font-size: 0.75rem;">Okazja <--- Średnia ---> Drogo</span>
        <span id="valuationDate" class="small text-muted" style="font-size: 0.75rem;"></span>
    </div>
</div>

            <div class="card border-0 p-4 rounded-4 shadow-sm bg-white">
                <h2 class="fw-bold mb-0">{{ car.marka }}</h2>
                <h4 class="text-muted">{{ car.model }}</h4>
                <p class="text-danger fw-bold"><i class="bi bi-geo-alt"></i> {{ car.zrodlo }} (Radom)</p>
                <h3 class="fw-bold text-primary my-3">{{ "{:,.0f}".format(car.cena).replace(',', ' ') }} PLN</h3>

                <div class="list-group list-group-flush mb-4">
                    <div class="list-group-item px-0 d-flex justify-content-between"><span>Rok produkcji:</span> <strong>{{ car.rok }}</strong></div>
                    <div class="list-group-item px-0 d-flex justify-content-between"><span>Przebieg:</span> <strong>{{ car.przebieg or '---' }} km</strong></div>
                    <div class="list-group-item px-0 d-flex justify-content-between"><span>Paliwo:</span> <strong>{{ car.paliwo or '---' }}</strong></div>
                    <div class="list-group-item px-0 d-flex justify-content-between"><span>Skrzynia:</span> <strong>{{ car.skrzynia or '---' }}</strong></div>
                </div>

                <a href="tel:{{ car.telefon }}" class="btn btn-dark w-100 py-3 fw-bold fs-5 mb-4 shadow"><i class="bi bi-telephone"></i> {{ car.telefon }}</a>

                <p class="small text-muted text-center fw-bold">SPRAWDŹ POJAZD:</p>
                <a href="https://www.carvertical.com/pl" target="_blank" class="partner-btn cv-btn"> carVertical</a>
                <a href="https://mubi.pl" target="_blank" class="partner-btn mubi-btn"> Kalkulator MUBI</a>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import PhotoSwipeLightbox from 'https://cdn.jsdelivr.net/npm/photoswipe@5.4.3/dist/photoswipe-lightbox.esm.js';
    const lightbox = new PhotoSwipeLightbox({
        gallery: '#car-gallery',
        children: 'a',
        pswpModule: () => import('https://cdn.jsdelivr.net/npm/photoswipe@5.4.3/dist/photoswipe.esm.js')
    });
    lightbox.init();

    window.updateGallery = function(src, thumb) {
        document.getElementById('mainDisplayImg').src = src;
        document.getElementById('mainDisplayImg').parentElement.href = src;
        document.querySelectorAll('.thumb-item').forEach(t => t.classList.remove('active'));
        thumb.classList.add('active');
    };

    window.askGemini = function() {
        const query = document.getElementById('userAiQuery').value;
        const resBox = document.getElementById('aiResponse');
        const resText = document.getElementById('aiResponseText');
        const spinner = document.getElementById('aiSpinner');

        if(!query) return;
        resBox.style.display = 'block';
        resText.innerText = ' Gemini myśli...';
        spinner.style.display = 'inline-block';

        fetch('/api/analyze-car', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                query: query, 
                marka: "{{ car.marka }}", 
                model: "{{ car.model }}"
            })
        })
        .then(r => r.json())
        .then(data => {
            spinner.style.display = 'none';
            resText.innerText = data.analysis;
        })
        .catch(err => {
            spinner.style.display = 'none';
            resText.innerText = "Błąd połączenia z AI.";
        });
    };
</script>
fetch('/api/check-price-valuation', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ car_id: "{{ car.id }}" })
})
.then(res => res.json())
.then(data => {
    document.getElementById('priceBar').style.width = data.score + '%';
    document.getElementById('priceBar').className = `progress-bar bg-${data.color}`;
    document.getElementById('priceLabel').innerText = data.label;
    document.getElementById('priceLabel').className = `badge rounded-pill bg-${data.color} px-3`;
    document.getElementById('valuationDate').innerText = "Aktualizacja: " + data.date;
});


{% endblock %}
