@app.route('/szukaj')
def szukaj():
    try:
        # 1. Pobieranie parametrów tekstowych
        marka = request.args.get('marka', '').strip()
        model = request.args.get('model', '').strip()
        kolor = request.args.get('kolor', '').strip()
        ai_ocena = request.args.get('ai_ocena', '')
        
        paliwo = request.args.get('paliwo', '')
        skrzynia = request.args.get('skrzynia', '')
        nadwozie = request.args.get('nadwozie', '')
        
        # 2. Bezpieczna konwersja liczb (Cena, Rok, Moc, PRZEBIEG)
        def get_int(key):
            val = request.args.get(key)
            return int(val) if val and val.isdigit() else None
            
        def get_float(key):
            val = request.args.get(key)
            try: return float(val) if val else None
            except: return None

        cena_min = get_float('cena_min')
        cena_max = get_float('cena_max')
        rok_min = get_int('rok_min')
        rok_max = get_int('rok_max')
        moc_min = get_int('moc_min')
        # --- NOWE: PRZEBIEG ---
        przebieg_min = get_int('przebieg_min')
        przebieg_max = get_int('przebieg_max')

        query = Car.query

        # 3. Filtrowanie (zabezpieczone ILIKE)
        if marka: query = query.filter(Car.marka.ilike(f'%{marka}%'))
        if model: query = query.filter(Car.model.ilike(f'%{model}%'))
        if kolor: query = query.filter(Car.kolor.ilike(f'%{kolor}%'))
        if ai_ocena: query = query.filter(Car.ai_label.contains(ai_ocena))
        
        if paliwo: query = query.filter(Car.paliwo == paliwo)
        if skrzynia: query = query.filter(Car.skrzynia == skrzynia)
        if nadwozie: query = query.filter(Car.nadwozie == nadwozie)
        
        if cena_min is not None: query = query.filter(Car.cena >= cena_min)
        if cena_max is not None: query = query.filter(Car.cena <= cena_max)
        if rok_min is not None: query = query.filter(Car.rok >= rok_min)
        if rok_max is not None: query = query.filter(Car.rok <= rok_max)
        
        # --- FILTROWANIE PRZEBIEGU ---
        if przebieg_min is not None: query = query.filter(Car.przebieg >= przebieg_min)
        if przebieg_max is not None: query = query.filter(Car.przebieg <= przebieg_max)
        
        if moc_min is not None: 
            query = query.filter(and_(Car.moc.isnot(None), Car.moc >= moc_min))
        
        # Sortowanie
        cars = query.order_by(Car.is_promoted.desc(), Car.data_dodania.desc()).limit(100).all()
        
        return render_template('szukaj.html', cars=cars, now=datetime.utcnow(), args=request.args)

    except Exception as e:
        return f"<h1 style='color:red;padding:20px;'>BŁĄD WYSZUKIWARKI: {str(e)}</h1>"
