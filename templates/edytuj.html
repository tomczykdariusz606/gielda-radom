<!DOCTYPE html>
<html lang="pl">
<head>
    <title>Edycja Ogłoszenia - Giełda Radom AI</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --radom-red: #ce2b37;
            --radom-dark: #1a1a1a;
            --gemini-grad: linear-gradient(135deg, #4285f4 0%, #9b72f3 100%);
        }
        body {
            font-family: 'Inter', sans-serif;
            background: #f4f7f6;
            min-height: 100vh;
            padding: 40px 0;
        }
        .edit-card {
            background: white;
            border-radius: 30px;
            border: none;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .edit-header {
            background: var(--radom-dark);
            color: white;
            padding: 40px;
            text-align: center;
            border-bottom: 5px solid var(--radom-red);
        }
        .form-label { font-weight: 700; font-size: 0.85rem; color: #444; text-transform: uppercase; margin-bottom: 8px; }
        .form-control, .form-select {
            border-radius: 12px;
            padding: 12px 15px;
            border: 2px solid #eee;
            transition: 0.3s;
        }
        .form-control:focus { border-color: var(--radom-red); box-shadow: none; background: #fff8f8; }
        
        .img-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 20px;
            border: 2px dashed #ddd;
        }
        .img-wrapper {
            position: relative;
            aspect-ratio: 4/3;
        }
        .img-wrapper img {
            width: 100%; height: 100%; object-fit: cover; border-radius: 12px;
        }
        .del-badge {
            position: absolute; top: -5px; right: -5px;
            background: var(--radom-red); color: white;
            border: none; border-radius: 50%; width: 25px; height: 25px;
            font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .btn-ai-gen {
            background: var(--gemini-grad); color: white;
            border: none; border-radius: 50px; padding: 5px 15px;
            font-size: 0.75rem; font-weight: 600;
        }
        .btn-save {
            background: var(--radom-red); color: white;
            border: none; border-radius: 50px; padding: 15px 40px;
            font-weight: 800; transition: 0.3s;
        }
        .btn-save:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(206, 43, 55, 0.3); color: white; }
    </style>
</head>
<body>

<div class="container" style="max-width: 900px;">
    <div class="edit-card">
        <div class="edit-header">
            <h2 class="fw-800 mb-1">Edytuj Ogłoszenie</h2>
            <p class="mb-0 opacity-75">Zaktualizuj dane swojego {{ car.marka }} {{ car.model }}</p>
        </div>

        <div class="p-4 p-md-5">
            <form method="POST" enctype="multipart/form-data">
                <div class="row g-4">
                    <div class="col-md-6">
                        <label class="form-label">Marka</label>
                        <input type="text" name="marka" id="editMarka" class="form-control" value="{{ car.marka }}" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Model</label>
                        <input type="text" name="model" id="editModel" class="form-control" value="{{ car.model }}" required>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Cena (PLN)</label>
                        <input type="number" name="cena" class="form-control" value="{{ car.cena|int }}" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Rok produkcji</label>
                        <input type="number" name="rok" id="editRok" class="form-control" value="{{ car.rok }}" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Przebieg (km)</label>
                        <input type="number" name="przebieg" id="editPrzebieg" class="form-control" value="{{ car.przebieg or 0 }}" required>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Paliwo</label>
                        <select name="paliwo" class="form-select">
                            <option value="Benzyna" {% if car.paliwo == 'Benzyna' %}selected{% endif %}>Benzyna</option>
                            <option value="Diesel" {% if car.paliwo == 'Diesel' %}selected{% endif %}>Diesel</option>
                            <option value="LPG" {% if car.paliwo == 'LPG' %}selected{% endif %}>LPG</option>
                            <option value="Hybryda" {% if car.paliwo == 'Hybryda' %}selected{% endif %}>Hybryda</option>
                            <option value="Elektryczny" {% if car.paliwo == 'Elektryczny' %}selected{% endif %}>Elektryczny</option>
                            <option value="Siła mięśni" {% if car.paliwo == 'Siła mięśni' %}selected{% endif %}>Siła mięśni</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Skrzynia</label>
                        <select name="skrzynia" class="form-select">
                            <option value="Manualna" {% if car.skrzynia == 'Manualna' %}selected{% endif %}>Manualna</option>
                            <option value="Automatyczna" {% if car.skrzynia == 'Automatyczna' %}selected{% endif %}>Automatyczna</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Nadwozie</label>
                        <select name="nadwozie" class="form-select">
                            <option value="Sedan" {% if car.nadwozie == 'Sedan' %}selected{% endif %}>Sedan</option>
                            <option value="Kombi" {% if car.nadwozie == 'Kombi' %}selected{% endif %}>Kombi</option>
                            <option value="SUV" {% if car.nadwozie == 'SUV' %}selected{% endif %}>SUV</option>
                            <option value="Hatchback" {% if car.nadwozie == 'Hatchback' %}selected{% endif %}>Hatchback</option>
                            <option value="Coupe" {% if car.nadwozie == 'Coupe' %}selected{% endif %}>Coupe</option>
                        </select>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Pojemność silnika</label>
                        <input type="text" name="pojemnosc" class="form-control" value="{{ car.pojemnosc or '' }}" placeholder="np. 2.0 TDI">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Telefon kontaktowy</label>
                        <input type="text" name="telefon" class="form-control" value="{{ car.telefon }}" required>
                    </div>

                    <div class="col-12">
                        <div class="d-flex justify-content-between mb-2">
                            <label class="form-label mb-0">Opis pojazdu</label>
                            <button type="button" class="btn-ai-gen" onclick="restyleDescription()">
                                <i class="bi bi-magic"></i> Popraw opis przez AI
                            </button>
                        </div>
                        <textarea name="opis" id="editOpis" class="form-control" rows="6" required>{{ car.opis }}</textarea>
                    </div>

                    <div class="col-12 mt-4">
                        <label class="form-label d-block">Zarządzaj Galerią</label>
                        <div class="img-grid mb-3">
                            {% if car.images %}
                                {% for img in car.images %}
                                <div class="img-wrapper" id="img-{{ img.id }}">
                                    <img src="{{ img.image_path }}">
                                    <button type="button" class="del-badge" onclick="deletePhoto({{ img.id }})">
                                        <i class="bi bi-x"></i>
                                    </button>
                                </div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        <input type="file" name="zdjecia" class="form-control" multiple accept="image/*">
                        <div class="form-text">Dodaj nowe zdjęcia, aby rozbudować galerię.</div>
                    </div>

                    <div class="col-12 d-flex justify-content-between align-items-center mt-5 pt-4 border-top">
                        <a href="/profil" class="text-decoration-none text-muted fw-bold">
                            <i class="bi bi-arrow-left"></i> Powrót
                        </a>
                        <button type="submit" class="btn btn-save">
                            ZAPISZ ZMIANY
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function deletePhoto(photoId) {
    if(confirm('Usunąć to zdjęcie?')) {
        fetch(`/usun_zdjecie/${photoId}`, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            if(data.success) document.getElementById(`img-${photoId}`).remove();
        });
    }
}

async function restyleDescription() {
    const btn = document.querySelector('.btn-ai-gen');
    const marka = document.getElementById('editMarka').value;
    const model = document.getElementById('editModel').value;
    const currentOpis = document.getElementById('editOpis').value;

    btn.innerHTML = '✨ Przetwarzam...';
    try {
        const res = await fetch('/api/generate-description', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ 
                marka, model, 
                rok: document.getElementById('editRok').value,
                przebieg: document.getElementById('editPrzebieg').value,
                current_text: currentOpis 
            })
        });
        const data = await res.json();
        document.getElementById('editOpis').value = data.description;
    } finally {
        btn.innerHTML = '<i class="bi bi-magic"></i> Popraw opis przez AI';
    }
}
</script>

</body>
</html>
