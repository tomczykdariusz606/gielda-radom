<!DOCTYPE html>
<html lang="pl" data-bs-theme="dark">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=AW-17939880807"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'AW-17939880807');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edycja - Giełda Radom</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        :root { --radom-red: #ce2b37; --bg-dark: #121212; --card-dark: #1e1e1e; }
        body { background-color: var(--bg-dark); color: #e4e6eb; font-family: 'Segoe UI', sans-serif; padding-bottom: 40px; }
        
        .navbar { background: rgba(0,0,0,0.95); backdrop-filter: blur(10px); border-bottom: 2px solid var(--radom-red); }
        
        .edit-box { 
            background: var(--card-dark); border: 1px solid #333; border-radius: 20px; padding: 40px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.5); 
        }
        
        .form-control, .form-select { 
            background-color: #2c2c2c; border: 1px solid #444; color: white; padding: 12px; border-radius: 10px;
        }
        .form-control:focus, .form-select:focus { 
            background-color: #333; border-color: var(--radom-red); color: white; box-shadow: 0 0 15px rgba(206, 43, 55, 0.2); 
        }
        
        .btn-ai { 
            background: linear-gradient(135deg, #2b1a1b, #000); border: 1px solid var(--radom-red); 
            color: var(--radom-red); font-weight: bold; transition: 0.3s;
        }
        .btn-ai:hover { background: var(--radom-red); color: white; box-shadow: 0 0 20px rgba(206, 43, 55, 0.4); }
        
        .img-preview-container { position: relative; width: 120px; height: 90px; border-radius: 10px; overflow: hidden; border: 1px solid #444; }
        .img-preview { width: 100%; height: 100%; object-fit: cover; }
        .btn-delete-img { 
            position: absolute; top: 5px; right: 5px; width: 25px; height: 25px; 
            background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; font-size: 14px; cursor: pointer; transition: 0.2s;
        }
        .btn-delete-img:hover { background: var(--radom-red); transform: scale(1.1); }
        .badge-main { position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(206, 43, 55, 0.8); color: white; font-size: 0.7rem; text-align: center; padding: 2px 0; }

        .btn-save-glow {
            background-color: var(--radom-red); color: white; font-weight: 800; text-transform: uppercase;
            letter-spacing: 1px; padding: 16px; width: 100%; border-radius: 50px; border: none;
            box-shadow: 0 5px 20px rgba(206, 43, 55, 0.4); font-size: 1.1rem; transition: 0.3s;
        }
        .btn-save-glow:hover { background-color: #b01b25; transform: scale(1.02); box-shadow: 0 10px 30px rgba(206, 43, 55, 0.6); }
    </style>
</head>
<body>

<nav class="navbar navbar-dark p-3 mb-5">
    <div class="container">
        <a class="navbar-brand fw-bold" href="/profil"><i class="bi bi-arrow-left me-2"></i> Wróć do Profilu</a>
        <span class="badge bg-dark border border-secondary text-secondary">ID: {{ car.id }}</span>
    </div>
</nav>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-9">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }} alert-dismissible fade show shadow-sm mb-4" role="alert">
                            <i class="bi bi-info-circle-fill me-2"></i> <strong>{{ message }}</strong>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-9">
            <div class="edit-box">
                <div class="d-flex align-items-center mb-4 border-bottom border-secondary pb-3">
                    <i class="bi bi-pencil-square fs-3 text-danger me-3"></i>
                    <div>
                        <h3 class="fw-bold text-white mb-0">Edycja Ogłoszenia</h3>
                        <small class="text-white-50">Zaktualizuj dane swojego pojazdu</small>
                    </div>
                </div>

                <form action="/edytuj/{{ car.id }}" method="POST" enctype="multipart/form-data">

                    <label class="text-uppercase text-secondary fw-bold small mb-3">Dane Podstawowe</label>
                    <div class="row g-3 mb-4">
                        <div class="col-12">
                            <label class="small text-muted mb-1">Kategoria</label>
                            <select name="typ" class="form-select bg-dark border-secondary text-white">
                                <option value="Osobowe" {% if car.typ=='Osobowe' %}selected{% endif %}>Osobowe</option>
                                <option value="SUV" {% if car.typ=='SUV' %}selected{% endif %}>SUV</option>
                                <option value="Minivan" {% if car.typ=='Minivan' %}selected{% endif %}>Minivan</option>
                                <option value="Ciezarowe" {% if car.typ=='Ciezarowe' %}selected{% endif %}>Dostawcze</option>
                                <option value="Moto/Rower" {% if car.typ=='Moto/Rower' %}selected{% endif %}>Moto/Rower</option>
                                <option value="Inne" {% if car.typ=='Inne' %}selected{% endif %}>Inne</option>
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="small text-muted mb-1">Marka</label>
                            <input type="text" name="marka" id="i_marka" class="form-control" value="{{ car.marka }}" required>
                        </div>
                        <div class="col-md-6">
                            <label class="small text-muted mb-1">Model</label>
                            <input type="text" name="model" id="i_model" class="form-control" value="{{ car.model }}" required>
                        </div>  
                        <div class="col-12">
                            <label class="form-label fw-bold text-success"><i class="bi bi-shield-lock"></i> Numer VIN</label>
                            <div class="input-group">
                                <span class="input-group-text bg-dark border-secondary text-success"><i class="bi bi-upc-scan"></i></span>
                                <input type="text" class="form-control text-uppercase" name="vin" placeholder="Wpisz 17 znaków..." maxlength="17" value="{{ car.vin or '' }}">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="small text-muted mb-1">Rok produkcji</label>
                            <input type="number" name="rok" id="i_rok" class="form-control" value="{{ car.rok }}">
                        </div>
                        <div class="col-md-4">
                            <label class="small text-muted mb-1">Przebieg (km)</label>
                            <input type="number" name="przebieg" id="i_przebieg" class="form-control" value="{{ car.przebieg }}">
                        </div>
                        <div class="col-md-4">
                            <label class="small text-muted mb-1 fw-bold text-danger">Cena (PLN)</label>
                            <input type="number" name="cena" id="i_cena" class="form-control border-danger text-danger fw-bold" value="{{ car.cena|int }}" required>
                        </div>
                    </div>

                    <label class="text-uppercase text-secondary fw-bold small mb-3">Szczegóły Techniczne</label>
                    <div class="row g-3 mb-4 p-4 bg-black bg-opacity-25 rounded-4 border border-secondary border-opacity-25">
                        
                        <div class="col-6">
                            <label class="small fw-bold text-warning mb-1">Moc Silnika (KM)</label>
                            <input type="number" name="moc" id="i_moc" class="form-control border-warning text-warning fw-bold" value="{{ car.moc or '' }}">
                        </div>
                        <div class="col-6">
                            <label class="small fw-bold text-warning mb-1">Kolor</label>
                            <input type="text" name="kolor" id="i_kolor" class="form-control border-warning" value="{{ car.kolor or '' }}">
                        </div>

                        <div class="col-6 col-md-4">
                            <label class="small text-muted mb-1">Paliwo</label>
                            <select name="paliwo" id="i_paliwo" class="form-select">
                                <option {% if car.paliwo=='Benzyna' %}selected{% endif %}>Benzyna</option>
                                <option {% if car.paliwo=='Diesel' %}selected{% endif %}>Diesel</option>
                                <option {% if car.paliwo=='LPG' %}selected{% endif %}>LPG</option>
                                <option {% if car.paliwo=='Hybryda' %}selected{% endif %}>Hybryda</option>
                                <option {% if car.paliwo=='Elektryczny' %}selected{% endif %}>Elektryczny</option>
                            </select>
                        </div>
                        <div class="col-6 col-md-4">
                            <label class="small text-muted mb-1">Skrzynia</label>
                            <select name="skrzynia" class="form-select">
                                <option {% if car.skrzynia=='Manualna' %}selected{% endif %}>Manualna</option>
                                <option {% if car.skrzynia=='Automatyczna' %}selected{% endif %}>Automatyczna</option>
                            </select>
                        </div>
                        <div class="col-6 col-md-4">
                            <label class="small text-muted mb-1">Pojemność</label>
                            <input type="text" name="pojemnosc" id="i_pojemnosc" class="form-control" value="{{ car.pojemnosc or '' }}">
                        </div>
                        <div class="col-6 col-md-4">
                            <label class="small text-muted mb-1">Nadwozie</label>
                            <select name="nadwozie" class="form-select">
                                <option {% if car.nadwozie=='Sedan' %}selected{% endif %}>Sedan</option>
                                <option {% if car.nadwozie=='Kombi' %}selected{% endif %}>Kombi</option>
                                <option {% if car.nadwozie=='Hatchback' %}selected{% endif %}>Hatchback</option>
                                <option {% if car.nadwozie=='SUV' %}selected{% endif %}>SUV</option>
                                <option {% if car.nadwozie=='Minivan' %}selected{% endif %}>Minivan</option>
                                <option {% if car.nadwozie=='Coupe' %}selected{% endif %}>Coupe</option>
                                <option {% if car.nadwozie=='Kabriolet' %}selected{% endif %}>Kabriolet</option>
                                <option {% if car.nadwozie=='Pick-up' %}selected{% endif %}>Pick-up</option>
                                <option {% if car.nadwozie=='Motocykl' %}selected{% endif %}>Motocykl</option>
                                <option {% if car.nadwozie=='Inne' %}selected{% endif %}>Inne</option>
                            </select>
                        </div>
                        <div class="col-md-8">
                             <label class="small text-muted mb-1">Telefon</label>
                             <input type="text" name="telefon" class="form-control" value="{{ car.telefon }}" required>
                        </div>
                    </div>

                    <label class="text-uppercase text-secondary fw-bold small mb-3">Wyposażenie Pojazdu</label>
                    <div class="p-4 mb-4 bg-black bg-opacity-25 rounded-4 border border-secondary border-opacity-25" style="max-height: 250px; overflow-y: auto;">
                        <div class="row g-2">
                            {% set current_options = car.wyposazenie.split(',') if car.wyposazenie else [] %}
                            {% set all_options = [
                                'ABS', 'ESP', 'Poduszki powietrzne', 'Isofix', 'Asystent pasa ruchu', 'Czujnik martwego pola',
                                'Klimatyzacja', 'Klimatyzacja automatyczna', 'Skórzana tapicerka', 'Podgrzewane fotele', 'El. szyby', 'El. lusterka', 
                                'Tempomat', 'Tempomat aktywny', 'Keyless', 'Szyberdach', 'Webasto',
                                'Nawigacja', 'Bluetooth', 'Android Auto', 'Kamera cofania', 'Kamera 360', 
                                'Czujniki parkowania', 'Alufelgi', 'Światła LED', 'Hak'
                            ] %}
                            
                            {% for opcja in all_options %}
                            <div class="col-6 col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input bg-dark border-secondary" type="checkbox" name="wyposazenie" value="{{ opcja }}" id="w_{{ loop.index }}" 
                                    {% if opcja in current_options %}checked{% endif %}>
                                    <label class="form-check-label small text-white" for="w_{{ loop.index }}">
                                        {{ opcja }}
                                    </label>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="text-uppercase text-secondary fw-bold small">OPIS POJAZDU</label>
                            <button type="button" class="btn btn-sm btn-ai rounded-pill px-3 shadow" onclick="generujOpis()">
                                <i class="bi bi-stars"></i> Ulepsz Opis (AI)
                            </button>
                        </div>
                        <textarea name="opis" id="opisArea" class="form-control" rows="6" placeholder="Opisz stan techniczny, historię...">{{ car.opis }}</textarea>
                        <div id="aiLoader" class="small text-warning mt-2" style="display:none;">
                            <span class="spinner-border spinner-border-sm me-1"></span> Gemini AI generuje profesjonalny opis...
                        </div>
                    </div>

                    <div class="mb-5">
                        <label class="text-uppercase text-secondary fw-bold small mb-3">Galeria Zdjęć</label>
                        
                        <div class="d-flex gap-3 flex-wrap mb-3">
                            <div class="img-preview-container border-danger">
                                <img src="{{ car.img }}" class="img-preview">
                                <span class="badge-main">OKŁADKA</span>
                            </div>
                            {% for img in car.images %}
                            {% if img.image_path != car.img %}
                            <div class="img-preview-container" id="img-{{ img.id }}">
                                <img src="{{ img.image_path }}" class="img-preview">
                                <button type="button" class="btn-delete-img" onclick="usunZdjecie({{ img.id }})"><i class="bi bi-x"></i></button>
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>

                        <div class="input-group">
                            <input type="file" name="zdjecia" class="form-control" multiple accept="image/*" id="fileInput">
                            <label class="input-group-text bg-secondary text-white border-secondary" for="fileInput"><i class="bi bi-plus-lg me-2"></i> Dodaj nowe</label>
                        </div>
                    </div>

                    <button type="submit" class="btn-save-glow">
                        <i class="bi bi-check2-circle me-2"></i> ZAPISZ ZMIANY
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    async function generujOpis() {
        const data = {
            marka: document.getElementById('i_marka').value,
            model: document.getElementById('i_model').value,
            rok: document.getElementById('i_rok').value,
            przebieg: document.getElementById('i_przebieg').value,
            cena: document.getElementById('i_cena').value,
            paliwo: document.getElementById('i_paliwo').value,
            pojemnosc: document.getElementById('i_pojemnosc').value
        };

        const loader = document.getElementById('aiLoader');
        const area = document.getElementById('opisArea');
        loader.style.display = 'block';

        try {
            const resp = await fetch('/api/generuj-opis', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            const result = await resp.json();
            if(result.opis) {
                area.value = result.opis;
            } else {
                alert('Błąd: ' + result.error);
            }
        } catch(e) {
            alert('Wystąpił błąd połączenia z AI.');
        }
        loader.style.display = 'none';
    }

    async function usunZdjecie(id) {
        if(!confirm('Czy na pewno chcesz usunąć to zdjęcie?')) return;
        const r = await fetch('/usun_zdjecie/'+id, {method:'POST'});
        const d = await r.json();
        if(d.success) document.getElementById('img-'+id).remove();
        else alert('Błąd usuwania zdjęcia.');
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
