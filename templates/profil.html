<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=AW-17939880807"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'AW-17939880807');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ t['garage'] }} - Giełda Radom</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <style>
        :root { --radom-red: #ce2b37; --bg-dark: #f8f9fa; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-dark); padding-bottom: 80px; }
        .hero-section {
            background: linear-gradient(135deg, #1a1a1a 0%, #000000 100%);
            color: white; padding: 3rem 1rem; border-radius: 0 0 30px 30px; margin-bottom: 2rem;
            position: relative; overflow: hidden;
        }
        .hero-section::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: url("{{ url_for('static', filename='czerwiec_tlo.jpg') }}") center/cover;
            opacity: 0.2; z-index: 0;
        }
        .hero-content { position: relative; z-index: 1; }
        .stat-card {
            background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1); border-radius: 15px; padding: 1rem;
            text-align: center; transition: 0.3s;
        }
        .stat-card:hover { transform: translateY(-3px); background: rgba(255, 255, 255, 0.2); }
        .limit-bar { height: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; overflow: hidden; margin-top: 5px; }
        .limit-fill { height: 100%; background: var(--radom-red); width: {{ (current_user.ai_requests_today / 6) * 100 }}%; }
        
        .nav-bottom {
            position: fixed; bottom: 0; width: 100%; background: white; z-index: 1000;
            display: flex; justify-content: space-around; padding: 12px 0;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05); border-top: 1px solid #eee;
        }
        .nav-item { text-align: center; color: #adb5bd; text-decoration: none; font-size: 0.8rem; }
        .nav-item.active { color: var(--radom-red); font-weight: 700; }
        .nav-item i { font-size: 1.4rem; display: block; margin-bottom: 2px; }
        
        .car-card {
            background: white; border-radius: 15px; overflow: hidden; margin-bottom: 1rem;
            box-shadow: 0 2px 15px rgba(0,0,0,0.03); transition: 0.2s; position: relative;
        }
        .car-img { height: 180px; object-fit: cover; width: 100%; }
        .badge-status { position: absolute; top: 10px; right: 10px; padding: 5px 10px; border-radius: 20px; font-weight: 700; font-size: 0.75rem; }
        .badge-active { background: #d4edda; color: #155724; }
        .badge-promoted { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }

        .scan-btn-group { display: flex; gap: 10px; margin-bottom: 20px; }
        .scan-btn { flex: 1; border-radius: 12px; padding: 12px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; border: 2px dashed #dee2e6; background: white; color: #495057; transition: 0.2s; cursor: pointer; }
        .scan-btn:hover, .scan-btn.active { border-color: var(--radom-red); color: var(--radom-red); background: #fff5f5; }
        
        /* Styl Avatara */
        .user-avatar {
            width: 80px; height: 80px; border-radius: 50%; object-fit: cover;
            border: 3px solid rgba(255,255,255,0.3); box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>

    <div class="hero-section">
        <div class="hero-content container">
            <div class="d-flex align-items-center justify-content-between mb-4">
                <div class="d-flex align-items-center gap-3">
                    <img src="{{ current_user.avatar_url or 'https://placehold.co/100?text=U' }}" class="user-avatar" alt="Avatar">
                    
                    <div>
                        <h2 class="fw-bold m-0">{{ t['welcome_back'] }}, <br>{{ current_user.username }}!</h2>
                        <small class="opacity-75">{{ t['login_desc'] }}</small>
                    </div>
                </div>
                <a href="/logout" class="btn btn-sm btn-outline-light rounded-pill px-3"><i class="bi bi-box-arrow-right"></i> {{ t['logout'] }}</a>
            </div>

            <div class="row g-2">
                <div class="col-6">
                    <div class="stat-card">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="small opacity-75">{{ t['limit'] }}</span>
                            <i class="bi bi-robot"></i>
                        </div>
                        <h3 class="fw-bold m-0">{{ current_user.ai_requests_today }}/6</h3>
                        <div class="limit-bar"><div class="limit-fill"></div></div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="stat-card">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="small opacity-75">Twoje Auta</span>
                            <i class="bi bi-car-front"></i>
                        </div>
                        <h3 class="fw-bold m-0">{{ cars|length }}</h3>
                    </div>
                </div>
                
                {% if current_user.username == 'admin' or current_user.id == 1 %}
                <div class="col-12 mt-2">
                    <div class="stat-card bg-dark bg-opacity-50 border-danger">
                        <h6 class="text-danger fw-bold mb-2">ADMIN STATS</h6>
                        <div class="d-flex justify-content-around small">
                            <span><i class="bi bi-people"></i> {{ user_count }} Userów</span>
                            <span><i class="bi bi-eye"></i> {{ total_views }} Wyśw.</span>
                            <span class="text-success"><i class="bi bi-circle-fill" style="font-size: 8px;"></i> {{ online_count }} Online</span>
                        </div>
                        <div class="mt-2 d-flex gap-2 justify-content-center">
                            <a href="/admin/backup-db" class="btn btn-xs btn-outline-light" style="font-size: 0.7rem;">Pobierz DB</a>
                            <a href="/admin/full-backup" class="btn btn-xs btn-outline-warning" style="font-size: 0.7rem;">Full Backup</a>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="container mb-5">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} rounded-4 shadow-sm border-0 mb-4">
                        <i class="bi bi-info-circle me-2"></i> {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="card border-0 shadow-sm rounded-4 p-3 mb-5">
            <h5 class="fw-bold mb-3"><i class="bi bi-plus-circle-dotted me-2 text-danger"></i>{{ t['add'] }}</h5>
            
            <form action="/dodaj" method="POST" enctype="multipart/form-data" id="addForm">
                
                <div class="scan-btn-group">
                    <label class="scan-btn" onclick="startCamera()">
                        <i class="bi bi-camera-fill"></i> {{ t['scan_cam'] }}
                        <input type="file" name="scan_image" id="scanInput" accept="image/*" capture="environment" hidden onchange="analyzeImage(this)">
                    </label>
                    <label class="scan-btn">
                        <i class="bi bi-upload"></i> {{ t['scan_file'] }}
                        <input type="file" id="fileInput" accept="image/*" hidden onchange="analyzeImage(this)">
                    </label>
                </div>
                
                <div id="ai-loading" class="text-center py-3 d-none">
                    <div class="spinner-border text-danger" role="status"></div>
                    <p class="small text-muted mt-2">Gemini AI analizuje Twój pojazd...</p>
                </div>

                <div class="row g-2">
                    <div class="col-6">
                        <label class="small text-muted fw-bold">Marka</label>
                        <input type="text" name="marka" id="marka" class="form-control" required placeholder="np. BMW">
                    </div>
                    <div class="col-6">
                        <label class="small text-muted fw-bold">Model</label>
                        <input type="text" name="model" id="model" class="form-control" required placeholder="np. X5">
                    </div>
                    <div class="col-6">
                        <label class="small text-muted fw-bold">Rok</label>
                        <input type="number" name="rok" id="rok" class="form-control" placeholder="2015">
                    </div>
                    <div class="col-6">
                        <label class="small text-muted fw-bold">Cena (PLN)</label>
                        <input type="number" name="cena" class="form-control" placeholder="0">
                    </div>
                    <div class="col-6">
                        <label class="small text-muted fw-bold">Przebieg</label>
                        <input type="number" name="przebieg" class="form-control" placeholder="km">
                    </div>
                    <div class="col-6">
                        <label class="small text-muted fw-bold">Paliwo</label>
                        <select name="paliwo" id="paliwo" class="form-select">
                            <option value="Benzyna">Benzyna</option>
                            <option value="Diesel">Diesel</option>
                            <option value="LPG">LPG</option>
                            <option value="Hybryda">Hybryda</option>
                            <option value="Elektryk">Elektryk</option>
                        </select>
                    </div>
                    
                    <input type="hidden" name="typ" id="typ" value="Osobowe">
                    <input type="hidden" name="nadwozie" id="nadwozie">
                    <input type="hidden" name="skrzynia" id="skrzynia">
                    <input type="hidden" name="lat" id="lat">
                    <input type="hidden" name="lon" id="lon">
                </div>

                <div class="mt-3">
                    <label class="small text-muted fw-bold">Zdjęcia (Max 15)</label>
                    <input type="file" name="zdjecia" class="form-control" multiple accept="image/*">
                </div>
                
                <div class="mt-3">
                    <label class="small text-muted fw-bold">Opis</label>
                    <div class="position-relative">
                        <textarea name="opis" id="opis" class="form-control" rows="4" placeholder="Opis pojazdu..."></textarea>
                        <button type="button" class="btn btn-sm btn-light position-absolute bottom-0 end-0 m-2 border" onclick="generateDesc()">
                            <i class="bi bi-magic"></i> AI
                        </button>
                    </div>
                </div>

                <div class="mt-3">
                    <label class="small text-muted fw-bold">Telefon</label>
                    <input type="text" name="telefon" class="form-control" required placeholder="Twój numer">
                </div>

                <button type="submit" class="btn btn-danger w-100 mt-4 fw-bold py-3 rounded-3 shadow">DODAJ OGŁOSZENIE</button>
            </form>
        </div>

        <h5 class="fw-bold mb-3 ps-2">Twoje Aktywne Oferty</h5>
        {% for car in cars %}
        <div class="car-card">
            <span class="badge-status badge-active">AKTYWNE</span>
            <div class="row g-0">
                <div class="col-4">
                    <img src="{{ car.img }}" class="car-img">
                </div>
                <div class="col-8 p-3 d-flex flex-column justify-content-between">
                    <div>
                        <h6 class="fw-bold mb-1">{{ car.marka }} {{ car.model }}</h6>
                        <small class="text-muted">{{ car.rok }} • {{ car.paliwo }}</small>
                        <h5 class="text-danger fw-bold mt-2">{{ car.cena }} PLN</h5>
                    </div>
                    <div class="d-flex gap-2 mt-2">
                        <a href="/edytuj/{{ car.id }}" class="btn btn-sm btn-outline-secondary flex-grow-1">Edytuj</a>
                        <form action="/usun/{{ car.id }}" method="POST" onsubmit="return confirm('Usunąć?');">
                             <button class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></button>
                        </form>
                        <form action="/odswiez/{{ car.id }}" method="POST">
                             <button class="btn btn-sm btn-success"><i class="bi bi-arrow-clockwise"></i></button>
                        </form>
                    </div>
                </div>
            </div>
            
            {% if car.ai_label %}
            <div class="bg-light p-2 small border-top d-flex align-items-center gap-2">
                <i class="bi bi-stars text-warning"></i> 
                <span>AI Ocena: <strong>{{ (car.ai_label|from_json).label }}</strong></span>
            </div>
            {% endif %}
            
            <div class="bg-light p-2 small border-top text-muted d-flex justify-content-between">
               <span><i class="bi bi-eye"></i> {{ car.views }} wyświetleń</span>
               <span>Dodano: {{ car.data_dodania.strftime('%Y-%m-%d') }}</span>
            </div>
        </div>
        {% else %}
        <div class="text-center py-5 opacity-50">
            <i class="bi bi-car-front display-1"></i>
            <p class="mt-3">Brak ogłoszeń. Dodaj pierwsze!</p>
        </div>
        {% endfor %}
        
        {% if (current_user.username == 'admin' or current_user.id == 1) and all_users %}
        <div class="mt-5">
            <h5 class="fw-bold text-danger">Zarządzanie Użytkownikami (ADMIN)</h5>
            <div class="bg-white rounded-4 shadow-sm p-3">
                <div class="table-responsive">
                    <table class="table table-sm table-hover" style="font-size: 0.8rem;">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>User</th>
                                <th>Email</th>
                                <th>Ostatnio</th>
                                <th>Akcja</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for u in all_users %}
                            <tr>
                                <td>{{ u.id }}</td>
                                <td>
                                    {% if u.avatar_url %}
                                    <img src="{{ u.avatar_url }}" width="20" height="20" class="rounded-circle me-1">
                                    {% endif %}
                                    {{ u.username }}
                                </td>
                                <td>{{ u.email }}</td>
                                <td>{{ u.last_seen.strftime('%H:%M %d-%m') if u.last_seen else '-' }}</td>
                                <td>
                                    {% if u.id != current_user.id %}
                                    <form action="/admin/usun_user/{{ u.id }}" method="POST" onsubmit="return confirm('Usunąć usera {{ u.username }}? To usunie też jego auta!');" class="d-inline">
                                        <button class="btn btn-danger p-0 px-1" style="font-size: 0.7rem;">X</button>
                                    </form>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}
        
    </div>

    <div class="nav-bottom">
        <a href="/" class="nav-item">
            <i class="bi bi-search"></i> Szukaj
        </a>
        <a href="/profil" class="nav-item active">
            <i class="bi bi-speedometer2"></i> Garaż
        </a>
        <a href="/kontakt" class="nav-item">
            <i class="bi bi-envelope"></i> Kontakt
        </a>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Geolokalizacja przy dodawaniu
        navigator.geolocation.getCurrentPosition(pos => {
            document.getElementById('lat').value = pos.coords.latitude;
            document.getElementById('lon').value = pos.coords.longitude;
        });

        function analyzeImage(input) {
            let file = input.files[0];
            if(!file) return;

            let formData = new FormData();
            formData.append('scan_image', file);

            document.getElementById('ai-loading').classList.remove('d-none');

            fetch('/api/analyze-car', { method: 'POST', body: formData })
            .then(r => r.json())
            .then(data => {
                document.getElementById('ai-loading').classList.add('d-none');
                if(data.error) {
                    alert(data.error);
                } else {
                    // Auto-uzupełnianie
                    if(data.marka && data.marka !== "String") document.getElementById('marka').value = data.marka;
                    if(data.model && data.model !== "String") document.getElementById('model').value = data.model;
                    if(data.rok_sugestia) document.getElementById('rok').value = data.rok_sugestia;
                    if(data.typ_nadwozia) document.getElementById('nadwozie').value = data.typ_nadwozia;
                    if(data.opis_wizualny) document.getElementById('opis').value = data.opis_wizualny;
                    
                    // Sugestia kategorii
                    if(data.kategoria) document.getElementById('typ').value = data.kategoria;
                }
            })
            .catch(e => {
                document.getElementById('ai-loading').classList.add('d-none');
                alert("Błąd połączenia z AI.");
            });
        }

        function generateDesc() {
            let marka = document.getElementById('marka').value;
            let model = document.getElementById('model').value;
            if(!marka) return alert("Wpisz najpierw markę i model!");
            
            let btn = event.target;
            btn.innerHTML = '<div class="spinner-border spinner-border-sm"></div>';
            
            fetch('/api/generuj-opis', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(marka + " " + model)
            })
            .then(r => r.json())
            .then(d => {
                document.getElementById('opis').value = d.opis;
                btn.innerHTML = '<i class="bi bi-magic"></i> AI';
            });
        }
    </script>
</body>
</html>
