<!DOCTYPE html>
<html lang="{{ lang }}" data-bs-theme="dark">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=AW-17939880807"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'AW-17939880807');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ t['garage'] }} - Gie≈Çda Radom</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
    
    <style>
        :root { --radom-red: #ce2b37; --bg-dark: #121212; --card-dark: #1e1e1e; --text-grey: #b0b3b8; --premium-gold: #f0c420; }
        
        body { background-color: var(--bg-dark); color: #e4e6eb; font-family: 'Segoe UI', sans-serif; padding-bottom: 90px; }
        
        /* NAVBAR Z LOGO */
        .navbar { background: rgba(0,0,0,0.95); border-bottom: 2px solid var(--radom-red); }

        .hero-section {
            background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
            position: relative; overflow: hidden;
            padding: 2rem 1rem 3rem 1rem;
            border-bottom: 2px solid var(--radom-red);
            border-radius: 0 0 30px 30px;
            margin-bottom: 2rem;
        }
        .hero-bg {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: url("{{ url_for('static', filename='czerwiec_tlo1.jpg') }}") center/cover;
            opacity: 0.15; z-index: 0;
        }
        .hero-content { position: relative; z-index: 1; }
        
        /* AVATAR */
        .profile-avatar {
            width: 90px; height: 90px; border-radius: 50%;
            border: 3px solid var(--radom-red);
            box-shadow: 0 0 20px rgba(206, 43, 55, 0.3);
            object-fit: cover;
            background: #000;
        }

        .glass-stat {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px; padding: 15px;
            height: 100%; transition: 0.3s;
        }
        .limit-bar-bg { background: rgba(255,255,255,0.1); height: 6px; border-radius: 10px; overflow: hidden; margin-top: 8px; }
        .limit-bar-fill { background: var(--radom-red); height: 100%; transition: width 0.5s; }

        .text-gold-glow { color: var(--premium-gold) !important; text-shadow: 0 0 15px rgba(240, 196, 32, 0.5); letter-spacing: 1px; }
        .btn-gold-premium {
            background: linear-gradient(135deg, #f0c420, #d4a017) !important;
            color: #000 !important; border: none !important; font-weight: 900 !important;
            box-shadow: 0 4px 15px rgba(240, 196, 32, 0.4) !important;
            transition: all 0.3s ease !important; position: relative; overflow: hidden;
        }
        .car-card { background-color: var(--card-dark); border: 1px solid #333; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.3); transition: transform 0.2s; }
        .car-card:hover { transform: translateY(-5px); border-color: var(--radom-red); }
        
        .cat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 20px; }
        .cat-item input { display: none; }
        .cat-label { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 70px; background: #2c2c2c; border: 1px solid #444; border-radius: 12px; cursor: pointer; font-size: 0.75rem; text-align: center; color: var(--text-grey); transition: 0.2s; }
        .cat-item input:checked + .cat-label { background: #3a1517; border-color: var(--radom-red); color: white; font-weight: bold; box-shadow: 0 0 10px rgba(206, 43, 55, 0.4); }
        
        .form-control, .form-select { background-color: #2c2c2c; border: 1px solid #444; color: white; padding: 10px; }
        .form-control:focus { background-color: #333; border-color: var(--radom-red); color: white; box-shadow: none; }
        
        /* --- NOWE STYLE DLA CUSTOMOWYCH LIST (DODANE) --- */
        .custom-dropdown-btn {
            background-color: #2c2c2c; border: 1px solid #444; color: white;
            width: 100%; padding: 10px; text-align: left; border-radius: 6px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .custom-dropdown-btn:hover, .custom-dropdown-btn[aria-expanded="true"] {
            background-color: #333; border-color: var(--radom-red); color: white;
        }
        .dropdown-menu-dark {
            background-color: #1a1a1a; border: 1px solid #333;
            box-shadow: 0 10px 40px rgba(0,0,0,0.9);
        }
        .dropdown-item { color: #ccc; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .dropdown-item:hover { background-color: var(--radom-red); color: white; }
        /* ------------------------------------------------ */

        .scanner-box { border: 2px dashed var(--premium-gold); border-radius: 15px; padding: 20px; text-align: center; background: rgba(0,0,0,0.3); margin-bottom: 20px; }
        .btn-submit-fix { background-color: var(--radom-red); color: white; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; padding: 15px; width: 100%; border-radius: 12px; border: none; box-shadow: 0 5px 15px rgba(206, 43, 55, 0.4); margin-top: 20px; }
        
        #aiToast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(240, 196, 32, 0.95); color: black;
            padding: 15px 25px; border-radius: 50px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            z-index: 9999; font-weight: bold; display: none;
            text-align: center; width: 90%; max-width: 400px;
            animation: slideUp 0.5s ease-out;
        }
        @keyframes slideUp { from { bottom: -100px; } to { bottom: 20px; } }
        
        /* --- NOWY PE≈ÅNOEKRANOWY LOADER Z WIDEO --- */
        #loaderOverlay {
            position: fixed; /* WA≈ªNE: FIXED NA PE≈ÅNY EKRAN */
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.92);
            z-index: 99999; /* ZAWSZE NA WIERZCHU */
            display: none;
            flex-direction: column; align-items: center; justify-content: center;
            backdrop-filter: blur(8px);
        }
        
        .loading-text {
            font-family: 'Inter', sans-serif; font-size: 1.2rem;
            font-weight: 700; color: white; letter-spacing: 3px;
            text-transform: uppercase;
            animation: pulseText 1.5s infinite ease-in-out;
            margin-top: 10px;
        }
        
        /* Styl wideo: cie≈Ñ i zaokrƒÖglenie */
        #loaderVideo {
            width: 150px; height: auto;
            border-radius: 50%; /* Opcjonalnie: ko≈Ço */
            box-shadow: 0 0 50px rgba(206,43,55, 0.4);
            margin-bottom: 20px;
        }

        @keyframes pulseText {
            0% { opacity: 0.4; transform: scale(0.98); }
            50% { opacity: 1; transform: scale(1.02); color: var(--radom-red); }
            100% { opacity: 0.4; transform: scale(0.98); }
        }
        /* ------------------------------------------- */

        .nav-bottom {
            position: fixed; bottom: 0; width: 100%; background: #000; z-index: 1000;
            display: flex; justify-content: space-around; padding: 12px 0;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5); border-top: 1px solid #333;
        }
        .nav-item { text-align: center; color: #666; text-decoration: none; font-size: 0.75rem; }
        .nav-item.active { color: var(--radom-red); font-weight: 700; }
        .nav-item i { font-size: 1.4rem; display: block; margin-bottom: 2px; }

        /* --- FIX: Ciemne Okienka (Modale) --- */
        .modal-content {
            background-color: #1a1a1a !important;   /* Ciemne t≈Ço */
            border: 1px solid #333 !important;       /* Ciemna ramka */
            color: #eee !important;                  /* Jasny tekst */
            box-shadow: 0 10px 50px rgba(0,0,0,0.9) !important;
        }
        .modal-header, .modal-footer {
            border-color: #333 !important;           /* Ciemne linie oddzielajƒÖce */
        }
        .btn-close {
            filter: invert(1) grayscale(100%) brightness(200%) !important; /* Bia≈Çy krzy≈ºyk */
        }
    </style>
</head>
<body class="pb-5">

    <nav class="navbar navbar-dark p-3 mb-0">
        <div class="container d-flex justify-content-between align-items-center">
            <a class="navbar-brand fw-bold fs-4 d-flex align-items-center" href="/">
                <img src="{{ url_for('static', filename='watermark.png') }}" alt="G" style="height: 45px; width: auto; margin-right: 10px; filter: drop-shadow(0 0 5px rgba(255,255,255,0.2));">
                <span style="font-family: 'Inter', sans-serif; letter-spacing: 1px;">GIE≈ÅDA <span class="text-danger">RADOM</span></span>
            </a>
            <a href="/logout" class="btn btn-sm btn-outline-danger rounded-pill px-3">{{ t['logout'] }}</a>
        </div>
    </nav>

    <div class="hero-section">
        <div class="hero-bg"></div>
        <div class="hero-content container">
            <div class="row align-items-center">
                <div class="col-auto">
                    <img src="{{ current_user.avatar_url or url_for('static', filename='watermark.png') }}" class="profile-avatar" alt="User">
                </div>
                <div class="col">
                    <h5 class="text-white-50 m-0 small text-uppercase mb-1">
                        {% if current_user.account_type == 'company' %}
                            <i class="bi bi-shop text-warning"></i> {{ t['company'] }}: {{ current_user.company_name }}
                        {% else %}
                            <i class="bi bi-person text-info"></i> {{ t['private_person'] }}
                        {% endif %}
                    </h5>
                    <h2 class="fw-bold text-white m-0 text-truncate">{{ current_user.username }}</h2>
                </div>
            </div>

            <div class="row g-2 mt-4">
                <div class="col-6">
                    <div class="glass-stat">
                        {% if current_user.username == 'admin' or current_user.id == 1 %}
                            {% set limit = 500 %}{% else %}{% set limit = 6 %}{% endif %}
                        {% set uzyte = current_user.ai_requests_today %}
                        {% set pozostalo = limit - uzyte %}{% if pozostalo < 0 %}{% set pozostalo = 0 %}{% endif %}
                        <div class="d-flex justify-content-between text-white-50 small mb-1"><span>{{ t['limit'] }}</span> <i class="bi bi-robot"></i></div>
                        <h4 class="fw-bold m-0 text-white">{{ pozostalo }}<span class="fs-6 text-muted">/{{ limit }}</span></h4>
                        <div class="limit-bar-bg"><div class="limit-bar-fill" style="width: {{ (uzyte / limit) * 100 }}%"></div></div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="glass-stat">
                        <div class="d-flex justify-content-between text-white-50 small mb-1"><span>Aktywne</span> <i class="bi bi-car-front"></i></div>
                        <h4 class="fw-bold m-0 text-white">{{ cars|length }} <span class="fs-6 text-muted">ofert</span></h4>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container" style="margin-top: -30px; position: relative; z-index: 10;">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show shadow-lg border-0 rounded-4" role="alert">
                        <i class="bi bi-info-circle-fill me-2"></i> {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <button class="btn btn-danger w-100 rounded-4 py-3 shadow-lg fw-bold mb-4 fs-5 d-flex align-items-center justify-content-center gap-2" data-bs-toggle="modal" data-bs-target="#dodajModal">
            <i class="bi bi-plus-circle-fill"></i> {{ t['add'] }}
        </button>

        <h5 class="fw-bold text-white mb-3 ps-2 border-start border-4 border-danger ps-3">{{ t['your_ads'] }}</h5>
        
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 mb-5">
            {% for car in cars %}
            <div class="col">
                <div class="card car-card h-100">
                    <div class="position-relative">
                        <img src="{{ car.img }}" class="card-img-top" style="height: 190px; object-fit: cover; opacity: 0.9;">
                        {% set dni = (now - car.data_dodania).days %}{% set left = 30 - dni %}
                        <span class="position-absolute top-0 end-0 m-2 badge {% if left < 3 %}bg-danger{% else %}bg-black{% endif %} bg-opacity-75 rounded-pill border border-secondary">{% if left > 0 %}{{ left }} {{ t['days_left'] }}{% else %}{{ t['expired'] }}{% endif %}</span>
                        {% if car.is_promoted %}<span class="position-absolute top-0 start-0 m-2 badge bg-warning text-dark border border-white shadow fw-bold">GOLD</span>{% endif %}
                    </div>
                    <div class="card-body d-flex flex-column">
                        <h5 class="fw-bold text-truncate text-white mb-1">{{ car.marka }} {{ car.model }}</h5>
                        <h4 class="text-danger fw-800">{{ "{:,.0f}".format(car.cena).replace(',', ' ') }} {{ car.waluta if car.waluta else 'PLN' }}</h4>
                        <div class="row g-2 small text-muted mb-3 mt-1">
                            <div class="col-6"><i class="bi bi-calendar3"></i> {{ car.rok }}</div>
                            <div class="col-6"><i class="bi bi-fuel-pump"></i> {{ car.paliwo }}</div>
                            <div class="col-6"><i class="bi bi-speedometer2"></i> {{ car.przebieg }}</div>
                            <div class="col-6"><i class="bi bi-eye"></i> {{ car.views }}</div>
                        </div>
                        <div class="mt-auto pt-3 border-top border-secondary d-grid gap-2">
                            <div class="d-flex gap-2">
                                <a href="/ogloszenie/{{ car.id }}" class="btn btn-outline-info btn-sm w-50 fw-bold"><i class="bi bi-eye"></i></a>
                                <a href="/edytuj/{{ car.id }}" class="btn btn-outline-light btn-sm w-50 fw-bold"><i class="bi bi-pencil"></i></a>
                            </div>
                            <div class="d-flex gap-2">
                                <form action="/odswiez/{{ car.id }}" method="POST" class="w-50"><button class="btn btn-success btn-sm w-100 fw-bold text-white"><i class="bi bi-arrow-clockwise"></i></button></form>
                                <form action="/usun/{{ car.id }}" method="POST" class="w-50" onsubmit="return confirm('?')"><button class="btn btn-dark btn-sm w-100 fw-bold border-secondary text-danger"><i class="bi bi-trash"></i></button></form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="col-12 text-center text-muted py-5 border border-secondary rounded-4 bg-dark bg-opacity-25">
                <i class="bi bi-car-front fs-1 mb-3 d-block opacity-25"></i>
                <h5 class="text-white opacity-50">{{ t['empty_garage'] }}</h5>
            </div>
            {% endfor %}
        </div>

        <h5 class="fw-bold text-white mb-3 mt-5 ps-2 border-start border-4 border-warning ps-3">{{ t['observed'] }}</h5>
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 mb-5">
            {% for fav in favorites %}
            {% set f_car = fav.car %}
            <div class="col">
                <div class="card car-card h-100 border-warning border-opacity-25">
                    <div class="position-relative">
                        <img src="{{ f_car.img }}" class="card-img-top" style="height: 160px; object-fit: cover; opacity: 0.8;">
                        <a href="/toggle_favorite/{{ f_car.id }}" class="position-absolute top-0 end-0 m-2 badge bg-danger rounded-circle p-2" style="cursor:pointer;"><i class="bi bi-heart-fill"></i></a>
                    </div>
                    <div class="card-body">
                        <h6 class="fw-bold text-truncate text-white mb-1">{{ f_car.marka }} {{ f_car.model }}</h6>
                        <div class="d-flex justify-content-between align-items-center"><span class="text-warning fw-bold">{{ "{:,.0f}".format(f_car.cena).replace(',', ' ') }} {{ f_car.waluta if f_car.waluta else 'PLN' }}</span><a href="/ogloszenie/{{ f_car.id }}" class="btn btn-sm btn-outline-warning py-0 px-2" style="font-size: 0.7rem;">{{ t['see_details'] }}</a></div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="col-12 text-center text-muted py-4 border border-secondary border-dashed rounded-4 bg-dark bg-opacity-10"><p class="small mb-0 opacity-25">{{ t['no_favorites'] }}</p></div>
            {% endfor %}
        </div>

        {% if current_user.username == 'admin' or current_user.id == 1 %}
        <div class="card admin-box shadow-lg mb-5 border-0" style="background: linear-gradient(145deg, #1a1a1a, #000); border-left: 5px solid #ffc107;">
            <div class="card-header bg-transparent border-warning d-flex justify-content-between align-items-center pt-3 pb-2">
                <h5 class="text-warning mb-0 fw-bold" style="letter-spacing: 1px;"><i class="bi bi-shield-lock-fill me-2"></i> CENTRUM DOWODZENIA</h5>
                <span class="badge bg-warning text-dark shadow fw-bold">ROOT</span>
            </div>
            <div class="card-body text-white">
                <div class="row g-3 mb-4 text-center">
                    <div class="col-4"><div class="p-3 rounded-3 border border-secondary bg-dark bg-opacity-50"><h3 class="fw-bold text-white mb-0">{{ user_count }}</h3><small class="text-secondary fw-bold" style="font-size:0.6rem;">KONTA</small></div></div>
                    <div class="col-4"><div class="p-3 rounded-3 border border-success bg-success bg-opacity-10"><h3 class="fw-bold text-success mb-0">{{ online_count }}</h3><small class="text-success fw-bold" style="font-size:0.6rem;">ONLINE</small></div></div>
                    <div class="col-4"><div class="p-3 rounded-3 border border-info bg-info bg-opacity-10"><h3 class="fw-bold text-info mb-0">{{ total_views }}</h3><small class="text-info fw-bold" style="font-size:0.6rem;">WIDOKI</small></div></div>
                </div>
                <div class="bg-black bg-opacity-25 p-3 rounded-3 border border-secondary">
                    <button class="btn btn-danger w-100 fw-bold shadow-sm mb-3" data-bs-toggle="modal" data-bs-target="#usersModal"><i class="bi bi-people-fill me-2"></i> ZARZƒÑDZAJ USERAMI</button>
                    <div class="d-flex gap-2"><a href="{{ url_for('backup_db') }}" class="btn btn-outline-warning w-100 fw-bold btn-sm py-2"><i class="bi bi-database"></i> SQL</a><a href="{{ url_for('full_backup') }}" class="btn btn-warning w-100 fw-bold btn-sm py-2 text-dark"><i class="bi bi-archive-fill"></i> ZIP</a></div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <div class="text-center mt-5 mb-5 pb-5 opacity-50">
            <form action="/usun_konto" method="POST" onsubmit="return confirm('Czy na pewno?');"><button class="btn btn-link text-danger text-decoration-none btn-sm">Usu≈Ñ konto</button></form>
        </div>
    </div>

    <div class="nav-bottom">
        <a href="/szukaj" class="nav-item"><i class="bi bi-search"></i> {{ t['search'] }}</a>
        <a href="/profil" class="nav-item active"><i class="bi bi-speedometer2"></i> {{ t['garage'] }}</a>
        <a href="/kontakt" class="nav-item"><i class="bi bi-envelope"></i> {{ t['contact'] }}</a>
    </div>

    <div class="modal fade" id="dodajModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content shadow-lg rounded-4 bg-dark border border-secondary">
                <div class="modal-header border-secondary"><h5 class="fw-bold text-white">{{ t['add'] }}</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <form action="/dodaj" method="POST" enctype="multipart/form-data" onsubmit="loadingEfekt(this); return true;">
                    <input type="hidden" name="lat" id="gps_lat"><input type="hidden" name="lon" id="gps_lon">

                    <div class="modal-body p-4 pt-2">
                        <div class="cat-grid">
                            <div class="cat-item"><input type="radio" name="typ" id="c1" value="Osobowe" checked onchange="adj()"><label for="c1" class="cat-label"><i class="bi bi-car-front"></i>Osobowe</label></div>
                            <div class="cat-item"><input type="radio" name="typ" id="c2" value="SUV" onchange="adj()"><label for="c2" class="cat-label"><i class="bi bi-jeep"></i>SUV</label></div>
                            <div class="cat-item"><input type="radio" name="typ" id="c3" value="Minivan" onchange="adj()"><label for="c3" class="cat-label"><i class="bi bi-people-fill"></i>Minivan</label></div>
                            <div class="cat-item"><input type="radio" name="typ" id="c4" value="Ciezarowe" onchange="adj()"><label for="c4" class="cat-label"><i class="bi bi-truck"></i>Bus</label></div>
                            <div class="cat-item"><input type="radio" name="typ" id="c5" value="Moto/Rower" onchange="adj()"><label for="c5" class="cat-label"><i class="bi bi-bicycle"></i>Moto</label></div>
                            <div class="cat-item"><input type="radio" name="typ" id="c6" value="Inne" onchange="adj()"><label for="c6" class="cat-label"><i class="bi bi-grid"></i>Inne</label></div>
                        </div>

                        <div class="scanner-box">
                            <div class="mb-3 text-gold-glow fw-bold fs-5"><i class="bi bi-stars"></i> GEMINI 3.0 EXPERT <i class="bi bi-stars"></i></div>
                            <div class="d-flex justify-content-center gap-3">
                                <label class="btn btn-gold-premium rounded-pill px-4 py-2 shadow-lg"><i class="bi bi-camera-fill me-2 fs-5"></i> {{ t['scan_cam'] }}<input type="file" name="scan_image_cam" accept="image/*" capture="environment" hidden onchange="scanCar(this)"></label>
                                <label class="btn btn-outline-light rounded-pill px-3 py-2 fw-bold"><i class="bi bi-folder-fill me-2"></i> {{ t['scan_file'] }}<input type="file" name="scan_image_file" accept="image/*" hidden onchange="scanCar(this)"></label>
                            </div>
                            <div id="scanLoader" class="mt-3 small text-warning fw-bold" style="display:none;"><span class="spinner-border spinner-border-sm me-1"></span> Analiza AI...</div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center"><label class="small fw-bold text-muted mb-1" id="photoLabel">ZDJƒòCIA</label><span class="small text-warning fw-bold">MAX 18</span></div>
                            <input type="file" name="zdjecia" class="form-control" multiple accept="image/*" id="fileInput">
                        </div>

                        <div class="row g-2">
                            <div class="col-6"><label class="small fw-bold text-muted">Marka</label><input type="text" name="marka" class="form-control" placeholder="np. BMW"></div>
                            <div class="col-6"><label class="small fw-bold text-muted">Model</label><input type="text" name="model" class="form-control" placeholder="np. X5"></div>
                            <div class="col-12"><label class="small fw-bold text-success">VIN</label><input type="text" name="vin" class="form-control text-uppercase" placeholder="VIN..." maxlength="17"></div>
                            <div class="col-4"><label class="small fw-bold text-muted">Rok</label><input type="number" name="rok" class="form-control"></div>
                            
                            <div class="col-4">
                                <label class="small fw-bold text-muted">Cena</label>
                                <div class="input-group">
                                    <input type="number" name="cena" class="form-control border-danger text-danger fw-bold" style="border-right: none;" required>
                                    <select name="waluta" class="form-select border-danger text-danger fw-bold px-1" style="max-width: 65px; background-color: #2c2c2c;">
                                        <option value="PLN">PLN</option>
                                        <option value="EUR">EUR</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="col-4 tech"><label class="small fw-bold text-muted">Przebieg</label><input type="number" name="przebieg" class="form-control"></div>
                            
                            <div class="col-6 tech"><label class="small fw-bold text-warning">Moc (KM)</label><input type="number" name="moc" class="form-control border-warning text-warning fw-bold" placeholder="np. 150"></div>
                            <div class="col-6 tech"><label class="small fw-bold text-warning">Kolor</label><input type="text" name="kolor" class="form-control border-warning" placeholder="np. Czarny"></div>

                            <div class="col-6 tech"><label class="small fw-bold text-muted">Pojemno≈õƒá</label><input type="text" name="pojemnosc" class="form-control"></div>
                            
                            <div class="col-6 tech">
                                <label class="small fw-bold text-muted">Paliwo</label>
                                <input type="hidden" name="paliwo" id="val_paliwo" value="Benzyna">
                                <div class="dropdown">
                                    <button class="btn custom-dropdown-btn dropdown-toggle" type="button" data-bs-toggle="dropdown" id="btn_paliwo">
                                        Benzyna
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-dark w-100">
                                        <li><a class="dropdown-item" href="#" onclick="setVal('paliwo', 'Benzyna')">Benzyna</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="setVal('paliwo', 'Diesel')">Diesel</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="setVal('paliwo', 'LPG')">LPG</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="setVal('paliwo', 'Hybryda')">Hybryda</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="setVal('paliwo', 'Elektryczny')">Elektryczny</a></li>
                                    </ul>
                                </div>
                            </div>

                            <div class="col-6 tech">
                                <label class="small fw-bold text-muted">Skrzynia</label>
                                <input type="hidden" name="skrzynia" id="val_skrzynia" value="Manualna">
                                <div class="dropdown">
                                    <button class="btn custom-dropdown-btn dropdown-toggle" type="button" data-bs-toggle="dropdown" id="btn_skrzynia">
                                        Manualna
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-dark w-100">
                                        <li><a class="dropdown-item" href="#" onclick="setVal('skrzynia', 'Manualna')">Manualna</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="setVal('skrzynia', 'Automatyczna')">Automatyczna</a></li>
                                    </ul>
                                </div>
                            </div>

                            <div class="col-12"><label class="small fw-bold text-muted">Telefon</label><input type="text" name="telefon" class="form-control" required></div>
                            <div class="col-12"><label class="small fw-bold text-muted">Opis</label><textarea name="opis" class="form-control" rows="3" placeholder="Opis..."></textarea></div>

                            <div class="col-12 mt-3">
                                <label class="small fw-bold text-muted mb-2">WYPOSA≈ªENIE (Zaznacz opcje)</label>
                                <div class="row g-2 p-3 rounded border border-secondary bg-black bg-opacity-25" style="max-height: 250px; overflow-y: auto;">
                                    <div class="col-12"><small class="text-secondary fw-bold">BEZPIECZE≈ÉSTWO</small></div>
                                    <div class="col-6 col-md-4"><div class="form-check"><input class="form-check-input bg-dark border-secondary" type="checkbox" name="wyposazenie" value="ABS" id="w1"><label class="form-check-label small text-white" for="w1">ABS</label></div></div>
                                    <div class="col-6 col-md-4"><div class="form-check"><input class="form-check-input bg-dark border-secondary" type="checkbox" name="wyposazenie" value="ESP" id="w2"><label class="form-check-label small text-white" for="w2">ESP / ASR</label></div></div>
                                    <div class="col-6 col-md-4"><div class="form-check"><input class="form-check-input bg-dark border-secondary" type="checkbox" name="wyposazenie" value="Poduszki powietrzne" id="w3"><label class="form-check-label small text-white" for="w3">Poduszki powietrzne</label></div></div>
                                    <div class="col-6 col-md-4"><div class="form-check"><input class="form-check-input bg-dark border-secondary" type="checkbox" name="wyposazenie" value="Isofix" id="w4"><label class="form-check-label small text-white" for="w4">Isofix</label></div></div>
                                    <div class="col-6 col-md-4"><div class="form-check"><input class="form-check-input bg-dark border-secondary" type="checkbox" name="wyposazenie" value="Asystent pasa ruchu" id="w5"><label class="form-check-label small text-white" for="w5">Asystent pasa ruchu</label></div></div>
                                    <div class="col-6 col-md-4"><div class="form-check"><input class="form-check-input bg-dark border-secondary" type="checkbox" name="wyposazenie" value="Czujnik martwego pola" id="w6"><label class="form-check-label small text-white" for="w6">Czujnik martwego pola</label></div></div>

                                    <div class="col-12 mt-2"><small class="text-secondary fw-bold">KOMFORT</small></div>
                                    <div class="col-6 col-md-4"><div class="form-check"><input class="form-check-input bg-dark border-secondary" type="checkbox" name="wyposazenie" value="Klimatyzacja" id="w7"><label class="form-check-label small text-white" for="w7">Klimatyzacja</label></div></div>
                                    <div class="col-6 col-md-4"><div class="form-check"><input class="form-check-input bg-dark border-secondary" type="checkbox" name="wyposazenie" value="Klimatronik" id="w8"><label class="form-check-label small text-white" for="w8">Klimatronik</label></div></div>
                                    <div class="col-6 col-md-4"><div class="form-check"><input class="form-check-input bg-dark border-secondary" type="checkbox" name="wyposazenie" value="Sk√≥rzana tapicerka" id="w9"><label class="form-check-label small text-white" for="w9">Sk√≥ry</label></div></div>
                                    <div class="col-6 col-md-4"><div class="form-check"><input class="form-check-input bg-dark border-secondary" type="checkbox" name="wyposazenie" value="Podgrzewane fotele" id="w10"><label class="form-check-label small text-white" for="w10">Grzane fotele</label></div></div>
                                    <div class="col-6 col-md-4"><div class="form-check"><input class="form-check-input bg-dark border-secondary" type="checkbox" name="wyposazenie" value="El. szyby" id="w11"><label class="form-check-label small text-white" for="w11">El. szyby</label></div></div>
                                    <div class="col-6 col-md-4"><div class="form-check"><input class="form-check-input bg-dark border-secondary" type="checkbox" name="wyposazenie" value="El. lusterka" id="w12"><label class="form-check-label small text-white" for="w12">El. lusterka</label></div></div>
                                    <div class="col-6 col-md-4"><div class="form-check"><input class="form-check-input bg-dark border-secondary" type="checkbox" name="wyposazenie" value="Tempomat" id="w13"><label class="form-check-label small text-white" for="w13">Tempomat</label></div></div>
                                    <div class="col-6 col-md-4"><div class="form-check"><input class="form-check-input bg-dark border-secondary" type="checkbox" name="wyposazenie" value="Tempomat aktywny" id="w14"><label class="form-check-label small text-white" for="w14">Tempomat Aktywny</label></div></div>
                                    <div class="col-6 col-md-4"><div class="form-check"><input class="form-check-input bg-dark border-secondary" type="checkbox" name="wyposazenie" value="Keyless" id="w15"><label class="form-check-label small text-white" for="w15">Keyless / Bezkluczykowy</label></div></div>
                                    <div class="col-6 col-md-4"><div class="form-check"><input class="form-check-input bg-dark border-secondary" type="checkbox" name="wyposazenie" value="Szyberdach" id="w16"><label class="form-check-label small text-white" for="w16">Szyberdach</label></div></div>
                                    <div class="col-6 col-md-4"><div class="form-check"><input class="form-check-input bg-dark border-secondary" type="checkbox" name="wyposazenie" value="Webasto" id="w17"><label class="form-check-label small text-white" for="w17">Webasto</label></div></div>

                                    <div class="col-12 mt-2"><small class="text-secondary fw-bold">MULTIMEDIA & INNE</small></div>
                                    <div class="col-6 col-md-4"><div class="form-check"><input class="form-check-input bg-dark border-secondary" type="checkbox" name="wyposazenie" value="Nawigacja" id="w18"><label class="form-check-label small text-white" for="w18">Nawigacja</label></div></div>
                                    <div class="col-6 col-md-4"><div class="form-check"><input class="form-check-input bg-dark border-secondary" type="checkbox" name="wyposazenie" value="Bluetooth" id="w19"><label class="form-check-label small text-white" for="w19">Bluetooth / USB</label></div></div>
                                    <div class="col-6 col-md-4"><div class="form-check"><input class="form-check-input bg-dark border-secondary" type="checkbox" name="wyposazenie" value="Android Auto" id="w20"><label class="form-check-label small text-white" for="w20">Android Auto / CarPlay</label></div></div>
                                    <div class="col-6 col-md-4"><div class="form-check"><input class="form-check-input bg-dark border-secondary" type="checkbox" name="wyposazenie" value="Kamera cofania" id="w21"><label class="form-check-label small text-white" for="w21">Kamera cofania</label></div></div>
                                    <div class="col-6 col-md-4"><div class="form-check"><input class="form-check-input bg-dark border-secondary" type="checkbox" name="wyposazenie" value="Kamera 360" id="w22"><label class="form-check-label small text-white" for="w22">Kamera 360</label></div></div>
                                    <div class="col-6 col-md-4"><div class="form-check"><input class="form-check-input bg-dark border-secondary" type="checkbox" name="wyposazenie" value="Czujniki parkowania" id="w23"><label class="form-check-label small text-white" for="w23">Czujniki parkowania</label></div></div>
                                    <div class="col-6 col-md-4"><div class="form-check"><input class="form-check-input bg-dark border-secondary" type="checkbox" name="wyposazenie" value="Alufelgi" id="w24"><label class="form-check-label small text-white" for="w24">Alufelgi</label></div></div>
                                    <div class="col-6 col-md-4"><div class="form-check"><input class="form-check-input bg-dark border-secondary" type="checkbox" name="wyposazenie" value="≈öwiat≈Ça LED" id="w25"><label class="form-check-label small text-white" for="w25">≈öwiat≈Ça LED / Xenon</label></div></div>
                                    <div class="col-6 col-md-4"><div class="form-check"><input class="form-check-input bg-dark border-secondary" type="checkbox" name="wyposazenie" value="Hak" id="w26"><label class="form-check-label small text-white" for="w26">Hak</label></div></div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3"><button type="button" class="btn btn-outline-success w-100 btn-sm rounded-pill py-2" onclick="getGPS(this)"><i class="bi bi-geo-alt-fill"></i> GPS</button></div>
                    </div>
                    <div class="modal-footer border-secondary pt-0 border-0"><button class="btn-submit-fix">{{ t['add'] }}</button></div>
                </form>
            </div>
        </div>
    </div>

    {% if current_user.username == 'admin' or current_user.id == 1 %}
    <div class="modal fade" id="usersModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border border-secondary text-white">
                <div class="modal-header border-secondary"><h5 class="fw-bold">Baza U≈ºytkownik√≥w</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <div class="modal-body p-0">
                    <div class="table-responsive">
                        <table class="table table-dark table-hover mb-0 text-center align-middle">
                            <thead><tr class="text-secondary small text-uppercase"><th>ID</th><th>Login</th><th>Typ Konta</th><th>Email</th><th>Akcja</th></tr></thead>
                            <tbody>
                                {% for u in all_users %}
                                <tr>
                                    <td>{{ u.id }}</td>
                                    <td class="fw-bold text-white">
                                        <img src="{{ u.avatar_url or url_for('static', filename='watermark.png') }}" width="25" height="25" class="rounded-circle me-2" style="object-fit:cover;">
                                        {{ u.username }}
                                    </td>
                                    <td class="small">
                                        {% if u.account_type == 'company' %}
                                            <span class="badge bg-warning text-dark"><i class="bi bi-shop"></i> {{ u.company_name }}</span>
                                        {% else %}
                                            <span class="badge bg-secondary"><i class="bi bi-person"></i> Prywatne</span>
                                        {% endif %}
                                    </td>
                                    <td class="small text-muted">{{ u.email }}</td>
                                    <td>{% if u.id != current_user.id %}<form action="/admin/usun_user/{{ u.id }}" method="POST" onsubmit="return confirm('UsunƒÖƒá?');"><button class="btn btn-sm btn-outline-danger border-0"><i class="bi bi-trash-fill"></i></button></form>{% else %}<span class="badge bg-warning text-dark">TY</span>{% endif %}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div id="cookie-banner" style="position: fixed; bottom: 0; left: 0; right: 0; background: #1a1a1a; border-top: 2px solid #ce2b37; padding: 15px; text-align: center; z-index: 9999; display: none; box-shadow: 0 -5px 20px rgba(0,0,0,0.8);">
        <div class="container d-flex flex-column flex-md-row justify-content-center align-items-center gap-3">
            <span class="text-light small">üç™ <strong>Pliki cookies</strong> sƒÖ u≈ºywane do logowania.</span>
            <button onclick="acceptCookies()" class="btn btn-sm btn-danger fw-bold px-4 rounded-pill">OK</button>
        </div>
    </div>

    <div id="loaderOverlay">
        
        <video autoplay muted loop playsinline id="loaderVideo">
            <source src="{{ url_for('static', filename='loading.mp4') }}" type="video/mp4">
            <img src="{{ url_for('static', filename='watermark.png') }}" class="spinning-logo">
        </video> 
        
        <div class="loading-text">TWORZENIE OG≈ÅOSZENIA...</div>
    </div>

    <div id="aiToast"><i class="bi bi-stars me-2"></i> Wykry≈Çem zdjƒôcia! AI analizuje...</div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function adj(){ const v = document.querySelector('input[name="typ"]:checked').value; const ukryj = (v === 'Inne'); document.querySelectorAll('.tech').forEach(e => { e.style.display = ukryj ? 'none' : 'block'; }); }
        function getGPS(btn){ if(!navigator.geolocation) { alert('Brak GPS'); return; } btn.innerHTML='...'; navigator.geolocation.getCurrentPosition(pos => { document.getElementById('gps_lat').value=pos.coords.latitude; document.getElementById('gps_lon').value=pos.coords.longitude; btn.className="btn btn-success w-100 btn-sm rounded-pill py-2"; btn.innerHTML="<i class='bi bi-check-lg'></i> OK"; }, err => { alert('B≈ÇƒÖd GPS'); }); }
        
        // POPRAWIONY LOADING EFEKT
        function loadingEfekt(form) { 
            // Poka≈º overlay
            document.getElementById('loaderOverlay').style.display = 'flex'; 
        }

        if (!localStorage.getItem('cookiesAccepted')) { document.getElementById('cookie-banner').style.display = 'block'; }
        function acceptCookies() { localStorage.setItem('cookiesAccepted', 'true'); document.getElementById('cookie-banner').style.display = 'none'; }
        
        // NOWA FUNKCJA DO OBS≈ÅUGI LIST ROZWIJANYCH
        function setVal(name, val) {
            document.getElementById('val_' + name).value = val;
            document.getElementById('btn_' + name).innerText = val;
        }

        async function performAnalysis(file) {
            const toast = document.getElementById('aiToast'); toast.style.display = 'block';
            const fd=new FormData(); fd.append('scan_image', file); 
            try { 
                const r=await fetch('/api/analyze-car', {method:'POST', body:fd}); const d=await r.json(); 
                if(d.marka){ 
                    if(d.kategoria){ let r=document.querySelector(`input[name="typ"][value="${d.kategoria}"]`); if(r){ r.checked=true; adj(); }} 
                    document.querySelector('[name="marka"]').value=d.marka; 
                    document.querySelector('[name="model"]').value=d.model;
                    if(d.vin) document.querySelector('[name="vin"]').value=d.vin; 
                    document.querySelector('[name="rok"]').value=d.rok_sugestia||''; 
                    document.querySelector('[name="opis"]').value=d.opis_wizualny;
                    
                    if(d.moc_sugestia) document.querySelector('[name="moc"]').value=d.moc_sugestia;
                    if(d.kolor) document.querySelector('[name="kolor"]').value=d.kolor;

                    if (d.wyposazenie_wykryte) {
                        d.wyposazenie_wykryte.forEach(item => {
                            let chk = document.querySelector(`input[name="wyposazenie"][value="${item}"]`);
                            if (chk) chk.checked = true;
                        });
                    }

                    // ZAKTUALIZOWANA LOGIKA PALIWA DLA CUSTOM DROPDOWN
                    if(d.paliwo_sugestia && d.kategoria!=='Inne'){
                        setVal('paliwo', d.paliwo_sugestia);
                    } 
                    
                    toast.innerHTML = '<i class="bi bi-check-circle-fill me-2"></i> Dane (Moc/Kolor/Opcje) uzupe≈Çnione!'; setTimeout(() => { toast.style.display = 'none'; }, 3000);
                } else { toast.style.display = 'none'; } 
            } catch(e){ console.error(e); toast.style.display = 'none'; } 
        }
        async function scanCar(input){ 
            if(!input.files[0]) return; 
            const mainInput = document.getElementById('fileInput'); const dt = new DataTransfer(); dt.items.add(input.files[0]); mainInput.files = dt.files;
            const headerLabel = document.getElementById('photoLabel'); headerLabel.innerHTML = 'ZDJƒòCIA <span class="text-success ms-2">‚úÖ SKAN DODANY!</span>';
            performAnalysis(input.files[0]);
        }
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const headerLabel = document.getElementById('photoLabel'); if(headerLabel.innerText.includes("SKAN")) { headerLabel.innerHTML = 'ZDJƒòCIA'; }
            if (this.files.length > 18) { alert('‚ö†Ô∏è Max 18 zdjƒôƒá.'); const dt = new DataTransfer(); for (let i = 0; i < 18; i++) { dt.items.add(this.files[i]); } this.files = dt.files; }
            const markaField = document.querySelector('[name="marka"]'); if (this.files.length > 0 && markaField.value.trim() === "") { performAnalysis(this.files[0]); }
        });
    </script>
</body>
</html>
