<div class="container mb-5">
    <h3 class="fw-bold mb-4 border-start border-danger border-5 ps-3">Twoje Pojazdy</h3>
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 mb-5">
        {% for car in cars %}
        <div class="col">
            <div class="card car-card h-100">
                <div class="position-relative">
                    <img src="{{ car.img }}" class="card-img-top" style="height: 200px; object-fit: cover;">
                    <div class="expiry-badge">Dodano: {{ car.data_dodania.strftime('%d.%m.%Y') }}</div>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h5 class="fw-bold mb-0 text-truncate">{{ car.marka }} {{ car.model }}</h5>
                        <span class="badge bg-light text-dark border">{{ car.typ }}</span>
                    </div>
                    <h4 class="text-danger fw-800 mb-3">{{ car.cena|int }} PLN</h4>
                    
                    <div class="spec-grid">
                        <div class="spec-item"><i class="bi bi-calendar3"></i> {{ car.rok }} r.</div>
                        <div class="spec-item"><i class="bi bi-speedometer2"></i> {{ car.przebieg }} km</div>
                        <div class="spec-item"><i class="bi bi-fuel-pump"></i> {{ car.paliwo }}</div>
                        <div class="spec-item"><i class="bi bi-gear-wide-connected"></i> {{ car.skrzynia }}</div>
                        <div class="spec-item"><i class="bi bi-car-front"></i> {{ car.nadwozie }}</div>
                        <div class="spec-item"><i class="bi bi-droplet"></i> {{ car.pojemnosc }}</div>
                    </div>

                    <div class="d-flex gap-2">
                        <a href="/edytuj/{{ car.id }}" class="btn btn-outline-primary btn-sm rounded-pill flex-grow-1">Edytuj</a>
                        <form action="/odswiez/{{ car.id }}" method="POST" class="flex-grow-1">
                            <button class="btn btn-outline-success btn-sm rounded-pill w-100">Od≈õwie≈º</button>
                        </form>
                        <form action="/usun/{{ car.id }}" method="POST" class="flex-grow-1">
                            <button class="btn btn-outline-danger btn-sm rounded-pill w-100" onclick="return confirm('UsunƒÖƒá?')">Usu≈Ñ</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    {% if current_user.id == 1 %}
    <div class="card p-4 rounded-4 shadow-sm border-0 mt-5 bg-white">
        <h4 class="fw-bold mb-4 text-primary"><i class="bi bi-terminal"></i> Konsola i Logi AI</h4>
        <div class="row text-center mb-4">
            <div class="col-md-4"><h6>ONLINE</h6><h2>{{ stats.users_online }}</h2></div>
            <div class="col-md-4"><h6>B≈ÅƒòDY API (24h)</h6><h2 class="text-danger" id="errorCounter">0</h2></div>
            <div class="col-md-4"><h6>LOGI</h6><div id="aiLogs" class="text-start small bg-dark text-success p-2 rounded" style="height: 100px; overflow-y: auto; font-family: monospace;">[System ready...]</div></div>
        </div>
        <div class="text-center">
            <a href="{{ url_for('backup_db') }}" class="btn btn-dark btn-sm rounded-pill">Kopia Bazy</a>
            <a href="{{ url_for('full_backup') }}" class="btn btn-primary btn-sm rounded-pill">Full Backup</a>
        </div>
    </div>
    {% endif %}
</div>

<div class="modal fade" id="dodajModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content rounded-4 border-0 shadow-lg">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title fw-bold"><i class="bi bi-stars text-warning"></i> Nowe Og≈Çoszenie AI</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="/dodaj" method="POST" enctype="multipart/form-data">
                <div class="modal-body p-4">
                    <div class="category-selector mb-4">
                        <div class="category-item">
                            <input type="radio" name="typ" id="typOs" value="Osobowe" checked onchange="toggleBike()">
                            <label class="category-label" for="typOs"><i class="bi bi-car-front"></i><span>Osobowe</span></label>
                        </div>
                        <div class="category-item">
                            <input type="radio" name="typ" id="typBus" value="Dostawcze" onchange="toggleBike()">
                            <label class="category-label" for="typBus"><i class="bi bi-truck"></i><span>Busy</span></label>
                        </div>
                        <div class="category-item">
                            <input type="radio" name="typ" id="typRow" value="Rowery" onchange="toggleBike()">
                            <label class="category-label" for="typRow"><i class="bi bi-bicycle"></i><span>Rower</span></label>
                        </div>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-6"><label class="small fw-bold">Marka</label><input type="text" name="marka" id="aiMarka" class="form-control" required></div>
                        <div class="col-md-6"><label class="small fw-bold">Model</label><input type="text" name="model" id="aiModel" class="form-control" required></div>
                        <div class="col-md-4"><label class="small fw-bold">Rok</label><input type="number" name="rok" id="aiRok" class="form-control"></div>
                        <div class="col-md-4"><label class="small fw-bold">Przebieg (km)</label><input type="number" name="przebieg" id="aiPrzebieg" class="form-control"></div>
                        <div class="col-md-4"><label class="small fw-bold">Cena (PLN)</label><input type="number" name="cena" class="form-control" required></div>
                        
                        <div class="col-md-4">
                            <label class="small fw-bold">Paliwo</label>
                            <select name="paliwo" id="aiPaliwo" class="form-select">
                                <option value="Benzyna">Benzyna</option><option value="Diesel">Diesel</option><option value="LPG">LPG</option><option value="Hybryda">Hybryda</option><option value="Elektryczny">Elektryczny</option><option value="Si≈Ça miƒô≈õni">Si≈Ça miƒô≈õni</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="small fw-bold">Skrzynia</label>
                            <select name="skrzynia" class="form-select">
                                <option value="Manualna">Manualna</option><option value="Automatyczna">Automatyczna</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="small fw-bold">Nadwozie</label>
                            <select name="nadwozie" class="form-select">
                                <option value="Sedan">Sedan</option><option value="Kombi">Kombi</option><option value="SUV">SUV</option><option value="Hatchback">Hatchback</option><option value="Coupe">Coupe</option><option value="Inne">Inne</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6"><label class="small fw-bold">Pojemno≈õƒá</label><input type="text" name="pojemnosc" class="form-control" placeholder="np. 2.0 TDI"></div>
                        <div class="col-md-6"><label class="small fw-bold">Telefon</label><input type="text" name="telefon" class="form-control" required></div>

                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="fw-bold small">Opis (AI + Twoje uwagi)</label>
                                <button type="button" class="btn-ai" onclick="generateDesc()">‚ú® Opis AI</button>
                            </div>
                            <textarea name="opis" id="aiOpis" class="form-control rounded-4" rows="8"></textarea>
                        </div>
                        <div class="col-12"><label class="small fw-bold">Zdjƒôcie</label><input type="file" name="zdjecia" id="imgInput" class="form-control"></div>
                    </div>
                </div>
                <div class="modal-footer"><button type="submit" class="btn btn-danger w-100 py-3 rounded-pill fw-bold">OPUBLIKUJ</button></div>
            </form>
        </div>
    </div>
</div>

<script>
// FUNKCJA LOGOWANIA B≈ÅƒòD√ìW DO ADMINA
function logToAdmin(msg) {
    const logBox = document.getElementById('aiLogs');
    const counter = document.getElementById('errorCounter');
    if(logBox) {
        const time = new Date().toLocaleTimeString();
        logBox.innerHTML = `[${time}] ${msg}<br>` + logBox.innerHTML;
        if(msg.includes('B≈ÇƒÖd')) counter.innerText = parseInt(counter.innerText) + 1;
    }
}

// OBS≈ÅUGA ZDJƒòCIA Z RAPORTEM B≈ÅƒòD√ìW 429
document.getElementById('imgInput').addEventListener('change', async function(e) {
    const title = document.querySelector('.modal-title');
    title.innerHTML = '‚åõ AI analizuje...';

    const formData = new FormData();
    formData.append('image', e.target.files[0]);

    try {
        const res = await fetch('/api/analyze-car', { method: 'POST', body: formData });
        const data = await res.json();

        if(res.status === 429) {
            logToAdmin("B≈ÇƒÖd 429: Przekroczono limit API Gemini.");
            title.innerHTML = '‚ùå Limit AI wyczerpany - wpisz rƒôcznie';
            return;
        }

        if(res.ok && data.marka) {
            document.getElementById('aiMarka').value = data.marka;
            document.getElementById('aiModel').value = data.model;
            document.getElementById('aiOpis').value = `ü§ñ ANALIZA WIZUALNA:\n${data.sugestia}\n\n__________________________\n‚úçÔ∏è TW√ìJ OPIS:\n`;
            title.innerHTML = '‚úÖ Rozpoznano: ' + data.marka;
            logToAdmin("Sukces: Rozpoznano " + data.marka);
        }
    } catch(err) { 
        logToAdmin("B≈ÇƒÖd krytyczny: " + err.message);
        title.innerHTML = 'B≈ÇƒÖd po≈ÇƒÖczenia'; 
    }
});
</script>
